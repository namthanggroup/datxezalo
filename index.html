<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒê·∫∑t xe Taxi ƒëi·ªán</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="max-w-md w-full bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold text-center mb-6">üöñ ƒê·∫∑t xe Taxi ƒëi·ªán</h1>
    <form id="bookingForm" class="space-y-6">

      <!-- Th√¥ng tin li√™n h·ªá -->
      <div>
        <h2 class="text-lg font-semibold mb-2">üì± Th√¥ng tin li√™n h·ªá</h2>
        <div>
          <label class="block text-sm mb-1">S·ªë ƒëi·ªán tho·∫°i *</label>
          <input type="tel" id="phone" required 
                 class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <!-- ƒê·ªãa ch·ªâ -->
      <div>
        <h2 class="text-lg font-semibold mb-2">üìç ƒê·ªãa ch·ªâ</h2>
        <div class="mb-2">
          <label class="block text-sm mb-1">T·ªânh/Th√†nh *</label>
          <select id="tinhThanh" required
                  class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500"></select>
        </div>
        <div class="mb-2">
          <label class="block text-sm mb-1">Qu·∫≠n/Huy·ªán *</label>
          <select id="quanHuyen" required
                  class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500"></select>
        </div>
        <div class="mb-2">
          <label class="block text-sm mb-1">Ph∆∞·ªùng/X√£ *</label>
          <select id="phuongXa" required
                  class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500"></select>
        </div>
        <div class="mb-2">
          <label class="block text-sm mb-1">ƒê·ªãa ch·ªâ chi ti·∫øt *</label>
          <input type="text" id="diaChiChiTiet" required 
                 placeholder="S·ªë nh√†, ƒë∆∞·ªùng..."
                 class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-2">
          <button type="button" id="btnGPS" 
                  class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">üìç L·∫•y v·ªã tr√≠ GPS</button>
          <input type="text" id="gpsToaDo" readonly 
                 placeholder="Ch∆∞a l·∫•y v·ªã tr√≠" 
                 class="w-full border rounded-lg p-2 mt-2 bg-gray-100">
        </div>
      </div>

      <!-- Th√¥ng tin ph∆∞∆°ng ti·ªán -->
      <div>
        <h2 class="text-lg font-semibold mb-2">üöó Th√¥ng tin ph∆∞∆°ng ti·ªán</h2>
        <div class="flex items-center space-x-2 mb-2">
          <label class="text-sm">S·ªë l∆∞·ª£ng xe *</label>
          <div class="flex items-center border rounded-lg">
            <button type="button" id="decrease" class="px-3 py-1">-</button>
            <input type="number" id="soLuong" min="1" value="1" required 
                   class="w-16 text-center border-l border-r">
            <button type="button" id="increase" class="px-3 py-1">+</button>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Lo·∫°i xe *</label>
          <select id="loaiXe" required
                  class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
            <option value="">-- Ch·ªçn lo·∫°i xe --</option>
          </select>
        </div>
      </div>

      <!-- Ghi ch√∫ -->
      <div>
        <h2 class="text-lg font-semibold mb-2">üìù Ghi ch√∫</h2>
        <textarea id="ghiChu" rows="2" 
                  class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <!-- Submit -->
      <div>
        <button type="submit" id="submitBtn"
                class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center">
          <span id="btnText">üì§ G·ª≠i y√™u c·∫ßu</span>
          <svg id="spinner" class="animate-spin h-5 w-5 ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
            <path class="opacity-75" fill="white" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
        </button>
      </div>
    </form>
  </div>

  <script>
    let locations = {};
    let cauHinhXe = [];

    // Load JSON T·ªânh/Qu·∫≠n/X√£
    fetch("locations.json")
      .then(res => res.json())
      .then(data => {
        locations = data;
        const tinhSelect = document.getElementById("tinhThanh");
        tinhSelect.innerHTML = '<option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>';
        Object.keys(locations).forEach(tinh => {
          tinhSelect.innerHTML += `<option value="${tinh}">${tinh}</option>`;
        });
      });

    // Load JSON lo·∫°i xe
    fetch("cau_hinh_xe.json")
      .then(res => res.json())
      .then(data => { cauHinhXe = data; });

    // Khi ch·ªçn t·ªânh => load huy·ªán
    document.getElementById("tinhThanh").addEventListener("change", e => {
      const tinh = e.target.value;
      const qhSelect = document.getElementById("quanHuyen");
      const pxSelect = document.getElementById("phuongXa");
      qhSelect.innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
      pxSelect.innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
      if (tinh && locations[tinh]) {
        Object.keys(locations[tinh]).forEach(qh => {
          qhSelect.innerHTML += `<option value="${qh}">${qh}</option>`;
        });
      }
    });

    // Khi ch·ªçn huy·ªán => load x√£ v√† lo·∫°i xe
    document.getElementById("quanHuyen").addEventListener("change", e => {
      const tinh = document.getElementById("tinhThanh").value;
      const qh = e.target.value;
      const pxSelect = document.getElementById("phuongXa");
      pxSelect.innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
      if (tinh && qh && locations[tinh] && locations[tinh][qh]) {
        locations[tinh][qh].forEach(px => {
          pxSelect.innerHTML += `<option value="${px}">${px}</option>`;
        });
      }

      // Load lo·∫°i xe
      const loaiXeSelect = document.getElementById("loaiXe");
      loaiXeSelect.innerHTML = '<option value="">-- Ch·ªçn lo·∫°i xe --</option>';
      const options = cauHinhXe
        .filter(item => item.Tinh_TP === tinh && item.Quan_Huyen === qh)
        .map(item => `<option value="${item.Loai_Xe}">${item.Loai_Xe}</option>`)
        .join("");
      loaiXeSelect.innerHTML += options || '<option value="">(Kh√¥ng c√≥ lo·∫°i xe)</option>';
    });

    // S·ªë l∆∞·ª£ng xe +/- 
    document.getElementById("increase").onclick = () => {
      let val = parseInt(document.getElementById("soLuong").value) || 1;
      document.getElementById("soLuong").value = val + 1;
    };
    document.getElementById("decrease").onclick = () => {
      let val = parseInt(document.getElementById("soLuong").value) || 1;
      if (val > 1) document.getElementById("soLuong").value = val - 1;
    };

    // L·∫•y GPS
    document.getElementById("btnGPS").onclick = () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          document.getElementById("gpsToaDo").value = pos.coords.latitude + "," + pos.coords.longitude;
        }, () => {
          alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠");
        });
      }
    };

    // Prefill localStorage
    window.onload = () => {
      ["phone","tinhThanh","quanHuyen","phuongXa","diaChiChiTiet","soLuong","loaiXe","ghiChu"].forEach(id=>{
        if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
      });
    };

    // Save form to localStorage
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea")
      .forEach(el => {
        el.addEventListener("change", ()=> localStorage.setItem(el.id, el.value));
      });

    // Submit
    document.getElementById("bookingForm").addEventListener("submit", e=>{
      e.preventDefault();
      document.getElementById("btnText").classList.add("hidden");
      document.getElementById("spinner").classList.remove("hidden");

      const payload = {
        phone: phone.value,
        tinh: tinhThanh.value,
        quan: quanHuyen.value,
        phuong: phuongXa.value,
        diaChi: diaChiChiTiet.value,
        gps: gpsToaDo.value,
        soLuong: soLuong.value,
        loaiXe: loaiXe.value,
        ghiChu: ghiChu.value
      };

      fetch("https://script.google.com/macros/s/AKfycbx8EVqG37czQ9ACGPHKDrOD6LUxmVXOLBJxdyKdwvb8YA6EIgfL-c6l0lUgEzHkJFeHLg/exec", {
        method:"POST",
        body: JSON.stringify(payload)
      }).then(res=>res.text())
        .then(msg=>{
          alert("‚úÖ ƒê·∫∑t xe th√†nh c√¥ng!");
          document.getElementById("btnText").classList.remove("hidden");
          document.getElementById("spinner").classList.add("hidden");
        }).catch(()=>{
          alert("‚ùå C√≥ l·ªói, th·ª≠ l·∫°i!");
          document.getElementById("btnText").classList.remove("hidden");
          document.getElementById("spinner").classList.add("hidden");
        });
    });
  </script>
</body>
</html>
