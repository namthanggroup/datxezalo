<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒê·∫∑t xe Taxi ƒëi·ªán Nam Th·∫Øng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-lg">
    <form id="bookingForm" class="bg-white shadow-xl rounded-2xl p-6 space-y-6">

      <!-- Th√¥ng tin li√™n h·ªá -->
      <div class="space-y-3">
        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Th√¥ng tin li√™n h·ªá</h2>
        <input id="phone" name="phone" type="tel" required placeholder="S·ªë ƒëi·ªán tho·∫°i *"
          class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
      </div>

      <!-- ƒê·ªãa ch·ªâ -->
      <div class="space-y-3">
        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">ƒê·ªãa ch·ªâ</h2>
        <select id="province" required class="w-full border rounded-lg px-3 py-2">
          <option value="">Ch·ªçn t·ªânh/th√†nh *</option>
        </select>
        <select id="district" required class="w-full border rounded-lg px-3 py-2">
          <option value="">Ch·ªçn qu·∫≠n/huy·ªán *</option>
        </select>
        <select id="ward" required class="w-full border rounded-lg px-3 py-2">
          <option value="">Ch·ªçn ph∆∞·ªùng/x√£ *</option>
        </select>
        <input id="address" type="text" required placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt *"
          class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
        <label class="block mb-1 font-medium">L·∫•y v·ªã tr√≠ GPS hi·ªán t·∫°i</label>
		  <button type="button" id="getLocationBtn" 
			class="w-full bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition">
			üìç L·∫•y v·ªã tr√≠
		  </button>
		  <input type="text" id="toaDo" name="toaDo" readonly 
			class="mt-2 w-full border rounded-lg p-2 bg-gray-100 text-gray-700"
			placeholder="Ch∆∞a c√≥ t·ªça ƒë·ªô" />
		  <p id="gpsStatus" class="text-sm text-gray-500 mt-1"></p>
      </div>

      <!-- Th√¥ng tin ph∆∞∆°ng ti·ªán -->
      <div class="space-y-3">
        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Th√¥ng tin ph∆∞∆°ng ti·ªán</h2>
        <div class="flex items-center space-x-3">
          <button type="button" id="minusQty" class="w-10 h-10 bg-gray-200 rounded-lg">-</button>
          <input id="quantity" type="number" value="1" min="1" required readonly
            class="w-16 text-center border rounded-lg">
          <button type="button" id="plusQty" class="w-10 h-10 bg-gray-200 rounded-lg">+</button>
        </div>
        <select id="carType" required class="w-full border rounded-lg px-3 py-2">
          <option value="">Ch·ªçn lo·∫°i xe *</option>
        </select>
      </div>

      <!-- Ghi ch√∫ -->
      <div>
        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Ghi ch√∫</h2>
        <textarea id="note" rows="3" placeholder="Ghi ch√∫ th√™m..."
          class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <!-- Submit -->
      <div>
        <button type="submit" id="submitBtn" 
          class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center">
          <span id="btnText">üöñ ƒê·∫∑t xe ngay</span>
          <svg id="spinner" class="animate-spin h-5 w-5 ml-2 hidden text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
        </button>
      </div>
    </form>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx8EVqG37czQ9ACGPHKDrOD6LUxmVXOLBJxdyKdwvb8YA6EIgfL-c6l0lUgEzHkJFeHLg/exec"; // <- ƒëi·ªÅn link Apps Script ·ªü ƒë√¢y

    // Prefill localStorage
    function saveLocalStorage() {
      const data = {
        phone: document.getElementById("phone").value,
        province: document.getElementById("province").value,
        district: document.getElementById("district").value,
        ward: document.getElementById("ward").value,
        address: document.getElementById("address").value,
        quantity: document.getElementById("quantity").value,
        carType: document.getElementById("carType").value,
        note: document.getElementById("note").value
      };
      localStorage.setItem("bookingForm", JSON.stringify(data));
    }

    function loadLocalStorage() {
      const data = JSON.parse(localStorage.getItem("bookingForm"));
      if (!data) return;
      Object.keys(data).forEach(id => {
        if (document.getElementById(id)) {
          document.getElementById(id).value = data[id];
        }
      });
    }

    // Quantity control
    document.getElementById("minusQty").onclick = () => {
      let qty = parseInt(document.getElementById("quantity").value);
      if (qty > 1) document.getElementById("quantity").value = qty - 1;
    };
    document.getElementById("plusQty").onclick = () => {
      let qty = parseInt(document.getElementById("quantity").value);
      document.getElementById("quantity").value = qty + 1;
    };

	  let locationsData = {};
let xeData = {};

// Load d·ªØ li·ªáu JSON
async function loadData() {
  try {
    const res1 = await fetch("locations.json");
    locationsData = await res1.json();

    const res2 = await fetch("cau_hinh_xe.json");
    xeData = await res2.json();

    // ƒê·ªï t·ªânh th√†nh ngay khi load
    const tinhSelect = document.getElementById("tinh");
    tinhSelect.innerHTML = `<option value="">-- Ch·ªçn T·ªânh/Th√†nh --</option>`;
    Object.keys(locationsData).forEach(tinh => {
      const opt = document.createElement("option");
      opt.value = tinh;
      opt.textContent = tinh;
      tinhSelect.appendChild(opt);
    });
  } catch (err) {
    console.error("L·ªói load JSON:", err);
  }
}

document.getElementById("tinh").addEventListener("change", (e) => {
  const tinh = e.target.value;
  const huyenSelect = document.getElementById("quan");
  const xaSelect = document.getElementById("phuong");
  const xeSelect = document.getElementById("loaiXe");

  huyenSelect.innerHTML = `<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>`;
  xaSelect.innerHTML = `<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>`;
  xeSelect.innerHTML = `<option value="">-- Ch·ªçn Lo·∫°i Xe --</option>`;

  if (tinh && locationsData[tinh]) {
    Object.keys(locationsData[tinh]).forEach(huyen => {
      const opt = document.createElement("option");
      opt.value = huyen;
      opt.textContent = huyen;
      huyenSelect.appendChild(opt);
    });
  }
});

document.getElementById("quan").addEventListener("change", (e) => {
  const tinh = document.getElementById("tinh").value;
  const huyen = e.target.value;
  const xaSelect = document.getElementById("phuong");
  const xeSelect = document.getElementById("loaiXe");

  xaSelect.innerHTML = `<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>`;
  xeSelect.innerHTML = `<option value="">-- Ch·ªçn Lo·∫°i Xe --</option>`;

  if (tinh && huyen && locationsData[tinh][huyen]) {
    locationsData[tinh][huyen].forEach(xa => {
      const opt = document.createElement("option");
      opt.value = xa;
      opt.textContent = xa;
      xaSelect.appendChild(opt);
    });
  }

  if (huyen && xeData[huyen]) {
    xeData[huyen].forEach(xe => {
      const opt = document.createElement("option");
      opt.value = xe;
      opt.textContent = xe;
      xeSelect.appendChild(opt);
    });
  }
});

// Load d·ªØ li·ªáu khi m·ªü trang
window.onload = loadData;

    // GPS
		document.getElementById("getLocationBtn").addEventListener("click", () => {
		  const gpsStatus = document.getElementById("gpsStatus");
		  const toaDoInput = document.getElementById("toaDo");

		  if (navigator.geolocation) {
			gpsStatus.textContent = "‚è≥ ƒêang l·∫•y v·ªã tr√≠...";
			navigator.geolocation.getCurrentPosition(
			  (position) => {
				const lat = position.coords.latitude.toFixed(6);
				const lng = position.coords.longitude.toFixed(6);
				toaDoInput.value = `${lat}, ${lng}`;
				gpsStatus.textContent = "‚úÖ L·∫•y t·ªça ƒë·ªô th√†nh c√¥ng!";
				gpsStatus.classList.remove("text-red-500");
				gpsStatus.classList.add("text-green-600");
			  },
			  (error) => {
				gpsStatus.textContent = "‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng th·ª≠ l·∫°i.";
				gpsStatus.classList.remove("text-green-600");
				gpsStatus.classList.add("text-red-500");
			  }
			);
		  } else {
			gpsStatus.textContent = "‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS.";
			gpsStatus.classList.add("text-red-500");
		  }
		});


    // Submit
    document.getElementById("bookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      saveLocalStorage();

      const btn = document.getElementById("submitBtn");
      document.getElementById("btnText").textContent = "ƒêang g·ª≠i...";
      document.getElementById("spinner").classList.remove("hidden");
      btn.disabled = true;

      const payload = {
        phone: phone.value,
        province: province.value,
        district: district.value,
        ward: ward.value,
        address: address.value,
        coords: coords.value,
        quantity: quantity.value,
        carType: carType.value,
        note: note.value
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });
        const result = await res.json();
        alert("‚úÖ ƒê·∫∑t xe th√†nh c√¥ng!");
      } catch (err) {
        alert("‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu: " + err);
      } finally {
        btn.disabled = false;
        document.getElementById("btnText").textContent = "üöñ ƒê·∫∑t xe ngay";
        document.getElementById("spinner").classList.add("hidden");
      }
    });

    loadLocalStorage();


  </script>
</body>
</html>
