<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ƒê·∫∑t xe Taxi ƒëi·ªán Nam Th·∫Øng</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-md mx-auto">
    <header class="p-4 sticky top-0 bg-white/90 backdrop-blur z-10 border-b">
      <h1 class="text-xl font-bold text-center text-indigo-600">ƒê·∫∑t xe Taxi ƒëi·ªán Nam Th·∫Øng</h1>
    </header>

    <form id="orderForm" class="p-4 space-y-5">
      <!-- Li√™n h·ªá -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">Th√¥ng tin li√™n h·ªá</h2>
        <input id="phone" name="phone" type="tel" required inputmode="numeric" pattern="^0\\d{9,10}$"
               placeholder="S·ªë ƒëi·ªán tho·∫°i (VD: 0912345678)"
               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
      </section>

      <!-- ƒêi·ªÉm ƒë√≥n -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">ƒêi·ªÉm ƒë√≥n</h2>
        <div class="grid grid-cols-1 gap-2">
          <select id="province" required class="w-full p-3 border rounded-lg">
            <option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>
          </select>
          <div class="grid grid-cols-2 gap-2">
            <select id="district" required class="p-3 border rounded-lg">
              <option value="">-- Qu·∫≠n/Huy·ªán --</option>
            </select>
            <select id="ward" required class="p-3 border rounded-lg">
              <option value="">-- Ph∆∞·ªùng/X√£ --</option>
            </select>
          </div>
          <input id="address" type="text" required placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt"
                 class="w-full p-3 border rounded-lg">
          <button type="button" id="getLocation"
                  class="w-full bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg">
            üìç L·∫•y v·ªã tr√≠ GPS & ph√¢n gi·∫£i t√™n (mi·ªÖn ph√≠, ƒë·ªãa gi·ªõi c≈©)
          </button>
          <p id="gpsStatus" class="text-sm text-gray-500"></p>
        </div>
      </section>

      <!-- ƒêi·ªÉm ƒë·∫øn -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">ƒêi·ªÉm ƒë·∫øn</h2>
        <input id="destination" type="text" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë·∫øn (ƒë∆∞·ªùng, s·ªë nh√†...)"
               class="w-full p-3 border rounded-lg">
      </section>

      <!-- H√†nh tr√¨nh & xe -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">H√†nh tr√¨nh & xe</h2>

        <div class="flex items-center gap-2 mb-3">
          <label class="text-gray-600">S·ªë kh√°ch:</label>
          <button type="button" id="decreaseQty" class="px-3 py-2 bg-gray-100 rounded-lg">-</button>
          <input id="quantity" type="number" min="1" value="1" required class="w-16 text-center border rounded-lg">
          <button type="button" id="increaseQty" class="px-3 py-2 bg-gray-100 rounded-lg">+</button>
        </div>

        <!-- Lo·∫°i cu·ªëc: button group -->
        <label class="text-gray-600 block mb-2">Lo·∫°i cu·ªëc:</label>
        <input type="hidden" id="tripType" value="">
        <div id="tripTypeGroup" class="flex gap-2 flex-wrap mb-3"></div>

        <!-- Lo·∫°i xe: button group (ƒë·ªï ƒë·ªông theo t·ªânh/huy·ªán) -->
        <label class="text-gray-600 block mb-2">Lo·∫°i xe:</label>
        <input type="hidden" id="carType" value="">
        <div id="carTypeGroup" class="flex gap-2 flex-wrap"></div>
      </section>

      <!-- Ghi ch√∫ -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">Ghi ch√∫</h2>
        <textarea id="note" rows="3" placeholder="V√≠ d·ª•: ƒê√≥n l√∫c 8h, c√≥ h√†nh l√Ω..."
                  class="w-full p-3 border rounded-lg"></textarea>
      </section>

      <!-- Submit sticky -->
      <div class="h-24"></div>
      <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-3">
        <button type="button" id="openConfirm" 
                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
          üöï ƒê·∫∑t cu·ªëc ngay
        </button>
        <p id="submitStatus" class="text-center text-sm mt-2"></p>
      </div>
    </form>
  </div>

  <!-- Modal x√°c nh·∫≠n -->
  <div id="confirmModal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center justify-center z-50">
    <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl p-4">
      <h3 class="text-lg font-semibold mb-3">X√°c nh·∫≠n ƒë·∫∑t chuy·∫øn</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <tbody id="confirmTable" class="align-top"></tbody>
        </table>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="cancelConfirm" class="flex-1 py-2 rounded-lg border">Kh√¥ng</button>
        <button id="finalSubmit" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white font-semibold">‚úÖ X√°c nh·∫≠n ƒë·∫∑t xe</button>
      </div>
    </div>
  </div>

  <!-- Modal th√†nh c√¥ng -->
  <div id="successModal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center justify-center z-50">
    <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl p-4">
      <h3 class="text-lg font-semibold mb-3">ƒê·∫∑t chuy·∫øn th√†nh c√¥ng</h3>
      <p id="successMsg" class="text-sm text-gray-700 whitespace-pre-line"></p>
      <div class="mt-4">
        <button id="closeSuccess" class="w-full py-2 rounded-lg bg-indigo-600 text-white font-semibold">ƒê√≥ng</button>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const scriptURL = "https://script.google.com/macros/s/AKfycbx8EVqG37czQ9ACGPHKDrOD6LUxmVXOLBJxdyKdwvb8YA6EIgfL-c6l0lUgEzHkJFeHLg/exec"; // TODO: thay b·∫±ng WebApp URL c·ªßa b·∫°n
let locationsData = {};
let carConfigData = {};

/* T·ªïng ƒë√†i theo t·ªânh */
function getCallCenterPhone(province) {
  const phoneNumbers = {
    'An Giang': '02973 56 56 56',
    'C√† Mau': '02903 56 56 56',
    'H·∫≠u Giang': '02973 95 95 95',
    'Ki√™n Giang': '02973 69 69 69',
    'Ph√∫ Qu·ªëc': '02973 75 75 75',
    'B·∫°c Li√™u': '02913 75 75 75',
    'S√≥c TrƒÉng': '0299 123 4567',
    'Vƒ©nh Long': '02913 59 59 59'
  };
  return phoneNumbers[province] || '1900 1234';
}

/* ================== LOAD DATA ================== */
async function loadData() {
  try {
    const locRes = await fetch("locations.json");
    locationsData = await locRes.json();

    const carRes = await fetch("cau_hinh_xe.json");
    carConfigData = await carRes.json();

    const provinceSelect = document.getElementById("province");
    provinceSelect.innerHTML = '<option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>';
    Object.keys(locationsData).forEach(tinh => {
      provinceSelect.innerHTML += `<option value="${tinh}">${tinh}</option>`;
    });

    cascadeLoadFromLocalStorage();
  } catch (e) {
    document.getElementById("submitStatus").innerText = "‚ö†Ô∏è Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu c·∫•u h√¨nh.";
    console.error(e);
  }
}
loadData();

/* ================== DROPDOWNS ================== */
document.getElementById("province").addEventListener("change", e => {
  const province = e.target.value;
  const districts = Object.keys(locationsData[province] || {});
  const districtSelect = document.getElementById("district");
  districtSelect.innerHTML = '<option value="">-- Qu·∫≠n/Huy·ªán --</option>';
  document.getElementById("ward").innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ --</option>';
  districts.forEach(qh => {
    districtSelect.innerHTML += `<option value="${qh}">${qh}</option>`;
  });

  // Reset nh√≥m n√∫t lo·∫°i xe khi ƒë·ªïi t·ªânh
  renderCarTypeGroup([]);
  document.getElementById("carType").value = "";
});

document.getElementById("district").addEventListener("change", e => {
  const province = document.getElementById("province").value;
  const district = e.target.value;

  // ƒê·ªï x√£
  const wards = locationsData[province]?.[district] || [];
  const wardSelect = document.getElementById("ward");
  wardSelect.innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ --</option>';
  wards.forEach(px => {
    wardSelect.innerHTML += `<option value="${px}">${px}</option>`;
  });

  // ƒê·ªï Lo·∫°i xe d·∫°ng button
  const carTypes = (carConfigData[province]?.[district] || []).map(v => ({ value: v, label: v }));
  const savedCarType = localStorage.getItem("carType") || "";
  renderCarTypeGroup(carTypes, savedCarType);
});

/* ================== QTY ================== */
document.getElementById("increaseQty").onclick = () => {
  let val = parseInt(document.getElementById("quantity").value) || 1;
  document.getElementById("quantity").value = val + 1;
};
document.getElementById("decreaseQty").onclick = () => {
  let val = parseInt(document.getElementById("quantity").value) || 1;
  if (val > 1) document.getElementById("quantity").value = val - 1;
};

/* ================== GPS + REVERSE (FREE) ================== */
async function reverseGeocode(lat, lon) {
  // Nominatim mi·ªÖn ph√≠ (t√¥n tr·ªçng rate limit). Thay email c·ªßa b·∫°n cho ƒë√∫ng policy.
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&accept-language=vi&email=youremail@example.com`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Reverse geocode failed");
  return res.json();
}

// Chu·∫©n ho√° t√™n ƒë·ªÉ kh·ªõp gi·ªØa d·ªØ li·ªáu OSM v√† file locations.json
function normalizeName(s) {
  if (!s) return "";
  return s.replace(/-/g, " ").replace(/\s+/g, " ").trim().toLowerCase();
}

// L·∫•y ƒë·ªãa gi·ªõi H√ÄNH CH√çNH l·ªãch s·ª≠ (tr∆∞·ªõc 01/07/2025) b·∫±ng Overpass
async function historicAdminAt(lat, lon) {
  const date = "2025-06-30T23:59:59Z"; // m·ªëc ƒë·ªãa gi·ªõi C≈®
  const query = `
[out:json][timeout:25][date:"${date}"];
is_in(${lat},${lon})->.a;
rel(area.a)[boundary=administrative];
out tags;
`;
  // Overpass ch√≠nh + fallback mirror
  const endpoints = [
    "https://overpass-api.de/api/interpreter",
    "https://overpass.kumi.systems/api/interpreter"
  ];
  let json = null, lastErr = null;
  for (const ep of endpoints) {
    try {
      const res = await fetch(ep, { method: "POST", body: query });
      if (res.ok) { json = await res.json(); break; }
    } catch (e) { lastErr = e; }
  }
  if (!json) throw (lastErr || new Error("Overpass failed"));

  // L·ªçc theo admin_level (VN th∆∞·ªùng: 4=T·ªânh/TP, 6=Qu·∫≠n/Huy·ªán/Th·ªã X√£, 8=Ph∆∞·ªùng/X√£)
  let adm4="", adm6="", adm8="";
  for (const el of (json.elements || [])) {
    const t = el.tags || {};
    const level = t["admin_level"];
    const name = t["name:vi"] || t["name"] || "";
    if (!level || !name) continue;
    if (level === "4" && !adm4) adm4 = name;
    if (level === "6" && !adm6) adm6 = name;
    if (level === "8" && !adm8) adm8 = name;
  }
  return { province: adm4, district: adm6, ward: adm8 };
}

// Th·ª≠ kh·ªõp t√™n OSM v√†o d·ªØ li·ªáu dropdown hi·ªán c√≥ v√† auto-select
function trySelectOldAdminToDropdowns(old) {
  const provinceSel = document.getElementById("province");
  const targetProv = normalizeName(old.province);
  if (targetProv) {
    let foundProv = "";
    for (const opt of provinceSel.options) {
      if (normalizeName(opt.value) === targetProv || normalizeName(opt.text) === targetProv) {
        foundProv = opt.value; break;
      }
    }
    if (foundProv) {
      provinceSel.value = foundProv;
      provinceSel.dispatchEvent(new Event("change"));
    }
  }

  const districtSel = document.getElementById("district");
  const targetDist = normalizeName(old.district);
  if (targetDist) {
    setTimeout(() => {
      let foundDist = "";
      for (const opt of districtSel.options) {
        if (normalizeName(opt.value) === targetDist || normalizeName(opt.text) === targetDist) {
          foundDist = opt.value; break;
        }
      }
      if (foundDist) {
        districtSel.value = foundDist;
        districtSel.dispatchEvent(new Event("change"));
      }

      const wardSel = document.getElementById("ward");
      const targetWard = normalizeName(old.ward);
      if (targetWard) {
        setTimeout(() => {
          for (const opt of wardSel.options) {
            if (normalizeName(opt.value) === targetWard || normalizeName(opt.text) === targetWard) {
              wardSel.value = opt.value; break;
            }
          }
          saveForm();
        }, 0);
      }
    }, 0);
  }
}

document.getElementById("getLocation").onclick = () => {
  const status = document.getElementById("gpsStatus");
  if (!navigator.geolocation) {
    status.innerText = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS.";
    return;
  }
  status.innerText = "ƒêang l·∫•y v·ªã tr√≠...";
  navigator.geolocation.getCurrentPosition(async pos => {
    try {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      localStorage.setItem("gps", `${lat},${lon}`);

      // 1) Nominatim (ƒë·ªãa ch·ªâ hi·ªán th·ªùi ƒë·ªÉ hi·ªÉn th·ªã d·ªÖ hi·ªÉu)
      const info = await reverseGeocode(lat, lon);
      const nice = info.display_name || `${lat}, ${lon}`;
      status.innerText = `üìç ${nice}`;

      // G·ª£i √Ω ƒëi·ªÅn ƒë·ªãa ch·ªâ chi ti·∫øt n·∫øu tr·ªëng
      const addrInput = document.getElementById("address");
      if (addrInput && !addrInput.value.trim()) {
        addrInput.value = nice;
        saveForm();
      }

      // 2) Overpass l·ªãch s·ª≠ (ƒë·ªãa gi·ªõi C≈®, m·ªëc 2025-06-30) -> t·ª± ƒëi·ªÅn dropdown
      try {
        const oldAdmin = await historicAdminAt(lat, lon);
        if (oldAdmin.province || oldAdmin.district || oldAdmin.ward) {
          trySelectOldAdminToDropdowns(oldAdmin);
          status.innerText += `\n(ƒê√£ t·ª± ƒëi·ªÅn theo ƒë·ªãa gi·ªõi c≈© tr∆∞·ªõc 01/07/2025)`;
        }
      } catch (e) {
        console.warn("Overpass historic admin lookup failed:", e);
      }
    } catch (err) {
      console.error(err);
      status.innerText = "ƒê√£ l·∫•y GPS nh∆∞ng kh√¥ng ph√¢n gi·∫£i ƒë∆∞·ª£c t√™n ƒë·ªãa ƒëi·ªÉm.";
    }
  }, () => {
    status.innerText = "Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS.";
  }, { enableHighAccuracy: true, timeout: 10000 });
};

/* ================== LOCAL STORAGE (ƒë·∫ßy ƒë·ªß) ================== */
let saveTimer;
function saveForm() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    const fields = ["phone","province","district","ward","address","quantity","carType","note","tripType","destination"];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) localStorage.setItem(id, el.value);
    });
  }, 150);
}
function cascadeLoadFromLocalStorage() {
  const get = k => localStorage.getItem(k) || "";
  ["phone","address","quantity","note","destination"].forEach(id=>{
    if (get(id)) document.getElementById(id).value = get(id);
  });

  // Trip type buttons
  const savedTrip = get("tripType");
  renderTripTypeButtons(savedTrip);
  document.getElementById("tripType").value = savedTrip;

  // Province -> District -> Ward -> CarType (buttons)
  if (get("province")) {
    document.getElementById("province").value = get("province");
    document.getElementById("province").dispatchEvent(new Event("change"));
  }
  if (get("district")) {
    document.getElementById("district").value = get("district");
    document.getElementById("district").dispatchEvent(new Event("change"));
  }
  if (get("ward")) {
    document.getElementById("ward").value = get("ward");
  }
  const savedCar = get("carType");
  if (savedCar) {
    // s·∫Ω ƒë∆∞·ª£c apply khi district change render xong group
    setTimeout(() => {
      const elHidden = document.getElementById("carType");
      elHidden.value = savedCar;
      // t√¥ active n·∫øu ƒë√£ v·∫Ω group
      Array.from(document.getElementById("carTypeGroup").children).forEach(btn => {
        if (btn.dataset && btn.dataset.value === savedCar) {
          btn.className = "px-3 py-2 rounded-lg border text-sm bg-indigo-600 text-white border-indigo-600";
        }
      });
    }, 0);
  }
}
document.querySelectorAll("input,select,textarea").forEach(el=>{
  el.addEventListener("change", saveForm);
  el.addEventListener("keyup", saveForm);
});

/* ================== BUTTON GROUP HELPERS ================== */
function renderButtonGroup(containerId, options, currentValue, onChange) {
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.dataset.value = opt.value;
    btn.className =
      "px-3 py-2 rounded-lg border text-sm " +
      (currentValue === opt.value
        ? "bg-indigo-600 text-white border-indigo-600"
        : "bg-white text-gray-700");
    btn.textContent = opt.label;

    btn.addEventListener("click", () => onChange(opt.value));
    el.appendChild(btn);
  });
}

// Trip type = 2 n√∫t c·ªë ƒë·ªãnh
function renderTripTypeButtons(currentValue="") {
  const options = [
    { value: "ngan", label: "ƒêi ng·∫Øn (‚â§20km)" },
    { value: "xa",   label: "ƒêi xa (>20km)" }
  ];
  const onChange = (val) => {
    document.getElementById("tripType").value = val;
    localStorage.setItem("tripType", val);
    renderTripTypeButtons(val); // re-render ƒë·ªÉ c·∫≠p nh·∫≠t active
  };
  renderButtonGroup("tripTypeGroup", options, currentValue, onChange);
}

// Car type = ƒë·ªï ƒë·ªông theo t·ªânh/huy·ªán
function renderCarTypeGroup(options=[], currentValue="") {
  const onChange = (val) => {
    document.getElementById("carType").value = val;
    localStorage.setItem("carType", val);
    renderCarTypeGroup(options, val); // re-render ƒë·ªÉ c·∫≠p nh·∫≠t active
  };
  renderButtonGroup("carTypeGroup", options, currentValue, onChange);
}

/* ================== SUBMIT FLOW (CONFIRM MODAL) ================== */
function collectFormData() {
  const province = document.getElementById("province").value;
  const district = document.getElementById("district").value;
  const ward = document.getElementById("ward").value;
  const addr = document.getElementById("address").value.trim();
  const fullAddress = `${addr} - ${ward} - ${district} - ${province}`;

  return {
    phone: (document.getElementById("phone").value || "").trim(),
    province, district, ward,
    address: fullAddress,
    quantity: Number(document.getElementById("quantity").value) || 1,
    carType: document.getElementById("carType").value,
    gps: localStorage.getItem("gps") || "",
    note: (document.getElementById("note").value || "").trim(),
    tripType: document.getElementById("tripType").value,
    destination: (document.getElementById("destination").value || "").trim()
  };
}

function showModal() {
  document.getElementById("confirmModal").classList.remove("hidden");
  document.getElementById("confirmModal").classList.add("flex");
}
function hideModal() {
  document.getElementById("confirmModal").classList.add("hidden");
  document.getElementById("confirmModal").classList.remove("flex");
}
function showSuccessModal(message) {
  document.getElementById("successMsg").innerText = message;
  document.getElementById("successModal").classList.remove("hidden");
  document.getElementById("successModal").classList.add("flex");
}
function hideSuccessModal() {
  document.getElementById("successModal").classList.add("hidden");
  document.getElementById("successModal").classList.remove("flex");
}

function renderConfirmTable(d) {
  const rows = [
    ["SƒêT", d.phone],
    ["T·ªânh/TP", d.province],
    ["Qu·∫≠n/Huy·ªán", d.district],
    ["Ph∆∞·ªùng/X√£", d.ward],
    ["ƒê·ªãa ch·ªâ ƒë√≥n", d.address],
    ["ƒêi·ªÉm ƒë·∫øn", d.destination || "(ch∆∞a nh·∫≠p)"],
    ["Lo·∫°i cu·ªëc", d.tripType === "xa" ? "ƒêi xa (>20km)" : "ƒêi ng·∫Øn (‚â§20km)"],
    ["S·ªë kh√°ch", d.quantity],
    ["Lo·∫°i xe", d.carType],
    ["Ghi ch√∫", d.note || "(kh√¥ng)"]
  ];
  const tbody = document.getElementById("confirmTable");
  tbody.innerHTML = rows.map(([k,v]) =>
    `<tr><td class="py-2 pr-3 text-gray-500">${k}</td><td class="py-2 font-medium">${v}</td></tr>`
  ).join("");
}

document.getElementById("openConfirm").addEventListener("click", () => {
  const d = collectFormData();

  const status = document.getElementById("submitStatus");
  status.innerText = "";
  if (!/^0\d{9,10}$/.test(d.phone)) {
    status.innerText = "‚ö†Ô∏è SƒêT ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 0 v√† c√≥ 10‚Äì11 s·ªë.";
    return;
  }
  if (!d.province || !d.district || !d.ward || !d.address) {
    status.innerText = "‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë·ªß t·ªânh/huy·ªán/x√£ v√† nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt.";
    return;
  }
  if (!d.carType) {
    status.innerText = "‚ö†Ô∏è Vui l√≤ng ch·ªçn lo·∫°i xe.";
    return;
  }

  renderConfirmTable(d);
  showModal();
});

document.getElementById("cancelConfirm").addEventListener("click", hideModal);
document.getElementById("closeSuccess").addEventListener("click", hideSuccessModal);

/* G·ª≠i l·∫ßn cu·ªëi (sau khi x√°c nh·∫≠n) */
document.getElementById("finalSubmit").addEventListener("click", submitOrderFinal);

async function submitOrderFinal() {
  const finalSubmitBtn = document.getElementById('finalSubmit');
  finalSubmitBtn.innerHTML = '‚è≥ ƒêang g·ª≠i...';
  finalSubmitBtn.disabled = true;

  const formData = collectFormData();
  const callCenterPhone = getCallCenterPhone(formData.province);

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });
    const payload = await res.json().catch(() => ({}));

    hideModal();

    if (!res.ok || payload.ok === false) {
      const errorMsg = payload && payload.error ? payload.error : `HTTP ${res.status}`;
      document.getElementById("submitStatus").innerText = '‚ùå C√≥ l·ªói x·∫£y ra: ' + errorMsg;
    } else {
      const successMessage =
        `ƒê√£ ghi nh·∫≠n th√¥ng tin ƒë·∫∑t xe c·ªßa Qu√Ω kh√°ch!\n\n` +
        `T·ªïng ƒë√†i s·∫Ω ki·ªÉm tra v√† ƒëi·ªÅu xe trong th·ªùi gian s·ªõm nh·∫•t.\n\n` +
        `M·ªçi th·∫Øc m·∫Øc li√™n h·ªá t·ªïng ƒë√†i: ${callCenterPhone}`;
      showSuccessModal(successMessage);
      resetAllForms();
    }
  } catch (error) {
    hideModal();
    document.getElementById("submitStatus").innerText = '‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
  } finally {
    finalSubmitBtn.innerHTML = '‚úÖ X√°c nh·∫≠n ƒë·∫∑t xe';
    finalSubmitBtn.disabled = false;
  }
}

function resetAllForms() {
  // Gi·ªØ l·∫°i SƒêT cho l·∫ßn ƒë·∫∑t sau; x√≥a c√°c field kh√°c
  const keep = ["phone"];
  Object.keys(localStorage).forEach(k => {
    if (!keep.includes(k)) localStorage.removeItem(k);
  });
  document.getElementById("orderForm").reset();
  // reset hidden + groups
  document.getElementById("tripType").value = "";
  document.getElementById("carType").value = "";
  renderTripTypeButtons("");
  renderCarTypeGroup([]);
  document.getElementById("submitStatus").innerText = "";
}
</script>
</body>
</html>
