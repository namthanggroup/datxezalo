<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đặt xe Taxi Nam Thắng</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-lg bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">Đặt xe Taxi Điện Nam Thắng</h1>

    <form id="bookingForm" class="space-y-6">

      <!-- Liên hệ -->
      <div>
        <h2 class="text-lg font-semibold mb-2 border-b pb-1">Thông tin liên hệ</h2>
        <label class="block mb-1 text-sm">Số điện thoại *</label>
        <input type="tel" id="sdt" name="sdt" required class="w-full border rounded-lg p-2" placeholder="Nhập số điện thoại">
      </div>

      <!-- Địa chỉ -->
      <div>
        <h2 class="text-lg font-semibold mb-2 border-b pb-1">Địa chỉ đón</h2>

        <label class="block mb-1 text-sm">Tỉnh/Thành *</label>
        <select id="tinh" required class="w-full border rounded-lg p-2 mb-3"></select>

        <label class="block mb-1 text-sm">Quận/Huyện *</label>
        <select id="quan" required class="w-full border rounded-lg p-2 mb-3"></select>

        <label class="block mb-1 text-sm">Phường/Xã *</label>
        <select id="phuong" required class="w-full border rounded-lg p-2 mb-3"></select>

        <label class="block mb-1 text-sm">Địa chỉ chi tiết *</label>
        <input type="text" id="diachi" name="diachi" required class="w-full border rounded-lg p-2 mb-3" placeholder="Số nhà, tên đường...">

        <div class="flex items-center space-x-2">
          <button type="button" onclick="getLocation()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
            Lấy vị trí GPS
          </button>
          <span id="gpsStatus" class="text-sm text-gray-600">Chưa lấy GPS</span>
        </div>
        <input type="hidden" id="toado" name="toado">
      </div>

      <!-- Phương tiện -->
      <div>
        <h2 class="text-lg font-semibold mb-2 border-b pb-1">Thông tin phương tiện</h2>

        <label class="block mb-1 text-sm">Số lượng xe *</label>
        <div class="flex items-center space-x-2 mb-3">
          <button type="button" onclick="changeSoLuong(-1)" class="px-3 py-1 bg-gray-300 rounded">-</button>
          <input type="number" id="soLuong" name="soLuong" value="1" min="1" required class="w-16 text-center border rounded">
          <button type="button" onclick="changeSoLuong(1)" class="px-3 py-1 bg-gray-300 rounded">+</button>
        </div>

        <label class="block mb-1 text-sm">Loại xe *</label>
        <select id="loaiXe" required class="w-full border rounded-lg p-2"></select>
      </div>

      <!-- Ghi chú -->
      <div>
        <h2 class="text-lg font-semibold mb-2 border-b pb-1">Ghi chú</h2>
        <textarea id="ghichu" name="ghichu" rows="3" class="w-full border rounded-lg p-2" placeholder="Thêm ghi chú nếu có..."></textarea>
      </div>

      <!-- Submit -->
      <div class="text-center">
        <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">
          Đặt xe
        </button>
      </div>
    </form>

    <!-- Loading -->
    <div id="loading" class="hidden mt-4 text-center text-gray-600">
      <span class="animate-spin inline-block w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full mr-2"></span>
      Đang xử lý...
    </div>
  </div>

  <script>
    let locationsData = {};
    let xeData = {};

    async function loadData() {
      try {
        const res1 = await fetch("locations.json");
        locationsData = await res1.json();

        const res2 = await fetch("cau_hinh_xe.json");
        xeData = await res2.json();

        // Đổ tỉnh
        const tinhSelect = document.getElementById("tinh");
        tinhSelect.innerHTML = `<option value="">-- Chọn Tỉnh/Thành --</option>`;
        Object.keys(locationsData).forEach(tinh => {
          const opt = document.createElement("option");
          opt.value = tinh;
          opt.textContent = tinh;
          tinhSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("Lỗi load JSON:", err);
      }
    }

    // Khi chọn tỉnh
    document.getElementById("tinh").addEventListener("change", (e) => {
      const tinh = e.target.value;
      const huyenSelect = document.getElementById("quan");
      const xaSelect = document.getElementById("phuong");
      const xeSelect = document.getElementById("loaiXe");

      huyenSelect.innerHTML = `<option value="">-- Chọn Quận/Huyện --</option>`;
      xaSelect.innerHTML = `<option value="">-- Chọn Phường/Xã --</option>`;
      xeSelect.innerHTML = `<option value="">-- Chọn Loại Xe --</option>`;

      if (tinh && locationsData[tinh]) {
        Object.keys(locationsData[tinh]).forEach(huyen => {
          const opt = document.createElement("option");
          opt.value = huyen;
          opt.textContent = huyen;
          huyenSelect.appendChild(opt);
        });
      }
    });

    // Khi chọn huyện
    document.getElementById("quan").addEventListener("change", (e) => {
      const tinh = document.getElementById("tinh").value;
      const huyen = e.target.value;
      const xaSelect = document.getElementById("phuong");
      const xeSelect = document.getElementById("loaiXe");

      xaSelect.innerHTML = `<option value="">-- Chọn Phường/Xã --</option>`;
      xeSelect.innerHTML = `<option value="">-- Chọn Loại Xe --</option>`;

      if (tinh && huyen && locationsData[tinh][huyen]) {
        locationsData[tinh][huyen].forEach(xa => {
          const opt = document.createElement("option");
          opt.value = xa;
          opt.textContent = xa;
          xaSelect.appendChild(opt);
        });
      }

      if (huyen && xeData[huyen]) {
        xeData[huyen].forEach(xe => {
          const opt = document.createElement("option");
          opt.value = xe;
          opt.textContent = xe;
          xeSelect.appendChild(opt);
        });
      }
    });
let cauHinhXe = [];
fetch("cau_hinh_xe.json")
  .then(res => res.json())
  .then(data => {
    cauHinhXe = data;
  });

// Khi thay đổi Quận/Huyện => load loại xe
document.getElementById("quanHuyen").addEventListener("change", () => {
  const tinh = document.getElementById("tinhThanh").value;
  const quan = document.getElementById("quanHuyen").value;
  const loaiXeSelect = document.getElementById("loaiXe");
  loaiXeSelect.innerHTML = '<option value="">-- Chọn loại xe --</option>';

  if (tinh && quan) {
    const options = cauHinhXe
      .filter(item => item.Tinh_TP === tinh && item.Quan_Huyen === quan)
      .map(item => `<option value="${item.Loai_Xe}">${item.Loai_Xe}</option>`)
      .join("");

    loaiXeSelect.innerHTML += options || '<option value="">(Không có loại xe khả dụng)</option>';
  }
});
    // Cộng trừ số lượng xe
    function changeSoLuong(val) {
      let input = document.getElementById("soLuong");
      let current = parseInt(input.value) || 1;
      current += val;
      if (current < 1) current = 1;
      input.value = current;
    }

    // Lấy GPS
    function getLocation() {
      if (navigator.geolocation) {
        document.getElementById("gpsStatus").textContent = "Đang lấy GPS...";
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const coords = pos.coords.latitude + "," + pos.coords.longitude;
            document.getElementById("toado").value = coords;
            document.getElementById("gpsStatus").textContent = "Thành công: " + coords;
          },
          () => {
            document.getElementById("gpsStatus").textContent = "Không lấy được GPS";
          }
        );
      } else {
        document.getElementById("gpsStatus").textContent = "Trình duyệt không hỗ trợ GPS";
      }
    }

    // Submit form
    document.getElementById("bookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      document.getElementById("loading").classList.remove("hidden");

      const data = {
        sdt: document.getElementById("sdt").value,
        tinh: document.getElementById("tinh").value,
        quan: document.getElementById("quan").value,
        phuong: document.getElementById("phuong").value,
        diachi: document.getElementById("diachi").value,
        toado: document.getElementById("toado").value,
        soLuong: document.getElementById("soLuong").value,
        loaiXe: document.getElementById("loaiXe").value,
        ghichu: document.getElementById("ghichu").value,
      };

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbx8EVqG37czQ9ACGPHKDrOD6LUxmVXOLBJxdyKdwvb8YA6EIgfL-c6l0lUgEzHkJFeHLg/exec", {
          method: "POST",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });

        const result = await response.json();
        alert("Đặt xe thành công!");
      } catch (err) {
        alert("Có lỗi xảy ra, vui lòng thử lại!");
        console.error(err);
      }

      document.getElementById("loading").classList.add("hidden");
    });

    window.onload = loadData;
  </script>
</body>
</html>
