<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Taxi ƒëi·ªán Nam Th·∫Øng</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-md mx-auto">
<header class="p-4 sticky top-0 bg-white/90 backdrop-blur z-10 border-b">
  <div class="flex items-center gap-3">
    <!-- Icon xe ƒëi·ªán xanh n√≥n chu·ªëi -->
    <svg viewBox="0 0 64 48" class="w-10 h-10 neon-icon">
      <!-- Th√¢n xe -->
      <defs>
        <linearGradient id="evGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#d9f99d"/>   <!-- lime-200 -->
          <stop offset="50%" stop-color="#a3e635"/>  <!-- lime-400 -->
          <stop offset="100%" stop-color="#22c55e"/> <!-- green-500 -->
        </linearGradient>
      </defs>
      <path d="M12 26h40a4 4 0 0 1 4 4v6H8v-6a4 4 0 0 1 4-4z" fill="url(#evGrad)"/>
      <path d="M20 26l6-8h12l6 8z" fill="#86efac"/>
      <!-- B√°nh xe -->
      <circle cx="20" cy="38" r="4" fill="#111827"/>
      <circle cx="44" cy="38" r="4" fill="#111827"/>
      <!-- Tia s√©t EV -->
      <path d="M34 8l-8 14h6l-2 10 10-16h-6l2-8z" fill="#84cc16"/>
    </svg>

    <h1 class="text-2xl sm:text-2xl font-extrabold leading-tight">
      <span class="bg-gradient-to-r from-lime-400 via-emerald-500 to-lime-500 bg-clip-text text-transparent shimmer-text">
        ƒê·∫∑t Xe Taxi ƒêi·ªán Nam Th·∫Øng
      </span>
    </h1>
  </div>
</header>

    <form id="orderForm" class="p-4 space-y-5">
	      <!-- Li√™n h·ªá -->
	  
      <!-- Li√™n h·ªá -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
	  <h2 class="text-base font-semibold text-gray-700 mb-3">T√™n ng∆∞·ªùi ƒë·∫∑t (*)</h2>
        <input id="zaloname" name="zaloname" type="text" required 
               placeholder="T√™n/ID ng∆∞·ªùi ƒë·∫∑t"
               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
			   
        <h2 class="text-base font-semibold text-gray-700 mb-3">ƒêi·ªán tho·∫°i li√™n h·ªá (*)</h2>
        <input id="phone" name="phone" type="tel" required inputmode="numeric" pattern="^0[0-9]{9,10}$"
               placeholder="S·ªë ƒëi·ªán tho·∫°i (VD: 0912345678)"
               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
      </section>

      <!-- ƒêi·ªÉm ƒë√≥n -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">ƒêi·ªÉm ƒë√≥n (*)</h2>

        <!-- Province -->
        <label class="text-gray-600 mb-1 block">T·ªânh/Th√†nh ph·ªë (*)</label>
        <div id="provinceWrapper" class="relative">
          <input id="provinceSearch" type="text" placeholder="T√¨m T·ªânh/Th√†nh ph·ªë..."
                 class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
		 <div id="provinceList" class="absolute left-0 top-full mt-1 z-50 bg-white border rounded-lg w-full max-h-60 overflow-auto shadow-lg hidden"></div>
          <select id="province" class="hidden">
            <option value=""></option>
          </select>
        </div>

        <!-- District + Ward -->
        <div class="grid grid-cols-1 gap-3 mt-3">
          <div>
            <label class="text-gray-600 mb-1 block">Qu·∫≠n/Huy·ªán (*)</label>
            <div id="districtWrapper" class="relative">
              <input id="districtSearch" type="text" placeholder="T√¨m Qu·∫≠n/Huy·ªán..."
                     class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
		 <div id="districtList" class="absolute left-0 top-full mt-1 z-50 bg-white border rounded-lg w-full max-h-60 overflow-auto shadow-lg hidden"></div>
              <select id="district" class="hidden">
                <option value=""></option>
              </select>
            </div>
          </div>
          <div>
            <label class="text-gray-600 mb-1 block">Ph∆∞·ªùng/X√£ (*)</label>
            <div id="wardWrapper" class="relative">
              <input id="wardSearch" type="text" placeholder="T√¨m Ph∆∞·ªùng/X√£..."
                     class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
		 <div id="wardList" class="absolute left-0 top-full mt-1 z-50 bg-white border rounded-lg w-full max-h-60 overflow-auto shadow-lg hidden"></div>
              <select id="ward" class="hidden">
                <option value=""></option>
              </select>
            </div>
          </div>
        </div>

        <input id="address" type="text" required placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt"
               class="w-full p-3 border rounded-lg mt-3">
        <button type="button" id="getLocation"
                class="w-full bg-lime-500 text-indigo-700 px-4 py-2 rounded-lg mt-2">
          üìç L·∫•y v·ªã tr√≠ GPS (ƒê·ªãa ch·ªâ m·ªõi)
        </button>
        <p id="gpsStatus" class="text-sm text-gray-500 mt-1"></p>
      </section>

      <!-- ƒêi·ªÉm ƒë·∫øn -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">ƒêi·ªÉm ƒë·∫øn(n·∫øu c√≥)</h2>
        <input id="destination" type="text" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë·∫øn (ƒë∆∞·ªùng, s·ªë nh√†...)"
               class="w-full p-3 border rounded-lg">
      </section>

      <!-- H√†nh tr√¨nh & xe -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">Th√¥ng tin xe</h2>

        <div class="flex items-center gap-2 mb-3">
          <label class="text-gray-600">S·ªë l∆∞·ª£ng xe: (*)</label>
          <button type="button" id="decreaseQty" class="px-3 py-2 bg-lime-500 rounded-lg">-</button>
          <input id="quantity" type="number" min="1" value="1" required class="w-16 text-center border rounded-lg">
          <button type="button" id="increaseQty" class="px-3 py-2 bg-lime-500 rounded-lg">+</button>
        </div>

        <!-- Lo·∫°i cu·ªëc: button group -->
        <label class="text-gray-600 block mb-2">Lo·∫°i cu·ªëc: (*)</label>
        <input type="hidden" id="tripType" value="">
        <div id="tripTypeGroup" class="flex gap-2 flex-wrap mb-3"></div>

        <!-- Lo·∫°i xe: button group (ƒë·ªï ƒë·ªông theo t·ªânh/huy·ªán) -->
        <label class="text-gray-600 block mb-2">Lo·∫°i xe: (*)</label>
        <input type="hidden" id="carType" value="">
        <div id="carTypeGroup" class="flex gap-2 flex-wrap"></div>
      </section>

      <!-- Ghi ch√∫ -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">Ghi ch√∫ (N·∫øu c√≥)</h2>
        <textarea id="note" rows="3" placeholder="V√≠ d·ª•: ƒê√≥n l√∫c 8h, c√≥ h√†nh l√Ω..."
                  class="w-full p-3 border rounded-lg"></textarea>
      </section>

      <!-- Submit sticky -->
      <div class="h-24"></div>
      <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-3">
        <button type="button" id="openConfirm" 
                class="w-full bg-lime-500 text-white py-3 rounded-lg font-semibold hover:bg-rose-600 transition">
          üöï ƒê·∫∑t cu·ªëc ngay
        </button>
        <p id="submitStatus" class="text-center text-sm mt-2"></p>
      </div>
    </form>
  </div>

  <!-- Modal x√°c nh·∫≠n -->
  <div id="confirmModal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center justify-center z-50">
    <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl p-4">
      <h3 class="text-lg font-semibold mb-3"> ‚úçÔ∏èX√°c nh·∫≠n ƒë·∫∑t chuy·∫øn</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <tbody id="confirmTable" class="align-top"></tbody>
        </table>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="cancelConfirm" class="flex-1 py-2 rounded-lg border">Kh√¥ng</button>
        <button id="finalSubmit" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white font-semibold">‚úÖ X√°c nh·∫≠n ƒë·∫∑t xe</button>
      </div>
    </div>
  </div>

  <!-- Modal th√†nh c√¥ng -->
  <div id="successModal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center justify-center z-50">
    <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl p-4">
      <h3 class="text-lg font-semibold mb-3">ƒê·∫∑t chuy·∫øn th√†nh c√¥ng</h3>
      <p id="successMsg" class="text-sm text-gray-700 whitespace-pre-line"></p>
      <div class="mt-4">
        <button id="closeSuccess" class="w-full py-2 rounded-lg bg-indigo-600 text-white font-semibold">ƒê√≥ng</button>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const scriptURL = "https://script.google.com/macros/s/AKfycbx8EVqG37czQ9ACGPHKDrOD6LUxmVXOLBJxdyKdwvb8YA6EIgfL-c6l0lUgEzHkJFeHLg/exec"; // TODO: thay b·∫±ng WebApp URL c·ªßa b·∫°n
let locationsData = {};
let carConfigData = {};

/* T·ªïng ƒë√†i theo t·ªânh */
function getCallCenterPhone(province) {
  const phoneNumbers = {
    'An Giang': '02973 56 56 56',
    'C√† Mau': '02903 56 56 56',
    'H·∫≠u Giang': '02973 95 95 95',
    'Ki√™n Giang': '02973 69 69 69',
    'Ph√∫ Qu·ªëc': '02973 75 75 75',
    'B·∫°c Li√™u': '02913 75 75 75',
    'S√≥c TrƒÉng': '0299 123 4567',
    'Vƒ©nh Long': '02913 59 59 59'
  };
  return phoneNumbers[province] || '0938 267 888';
}

/* ================== LOAD DATA ================== */
async function loadData() {
  try {
    const locRes = await fetch("locations.json");
    locationsData = await locRes.json();

    const carRes = await fetch("cau_hinh_xe.json");
    carConfigData = await carRes.json();

    // Province select options
    const provinceSelect = document.getElementById("province");
    provinceSelect.innerHTML = '<option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>';
    Object.keys(locationsData).forEach(tinh => {
      provinceSelect.innerHTML += `<option value="${tinh}">${tinh}</option>`;
    });

    // Init searchable for current options
    buildSearchable("province");
    cascadeLoadFromLocalStorage();
  } catch (e) {
    document.getElementById("submitStatus").innerText = "‚ö†Ô∏è Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu c·∫•u h√¨nh.";
    console.error(e);
  }
}

	
loadData();

/* ================== SEARCHABLE SELECT (vanilla) ================== */
function buildSearchable(kind) {
  const search = document.getElementById(`${kind}Search`);
  const list = document.getElementById(`${kind}List`);
  const select = document.getElementById(kind);

  function rebuildList() {
    const q = (search.value || "").toLowerCase().trim();
    list.innerHTML = "";
    const options = Array.from(select.options).filter(o => o.value);
    const filtered = q ? options.filter(o => o.text.toLowerCase().includes(q)) : options;
    if (!filtered.length) {
      list.innerHTML = `<div class="px-3 py-2 text-gray-500 text-sm">Kh√¥ng t√¨m th·∫•y</div>`;
      return;
    }
    filtered.forEach(opt => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "block w-full text-left px-3 py-2 hover:bg-indigo-50";
      btn.textContent = opt.text;
		btn.addEventListener("click", () => {
			 btn.addEventListener("mousedown", (ev) => {
		   ev.preventDefault();  // tr√°nh blur input tr∆∞·ªõc khi x·ª≠ l√Ω
		  // set gi√° tr·ªã th·∫≠t v√†o <select> ·∫©n
		  select.value = opt.value;
	
		 // hi·ªÉn th·ªã NH∆Ø GI√Å TR·ªä (ch·ªØ ƒëen), v√† g·∫Øn c·ªù ƒë√£ ch·ªçn
		 search.value = opt.text;
		 search.placeholder = "G√µ ƒë·ªÉ t√¨m...";
		 search.dataset.chosen = "1";      // <‚Äî c·ªù
		
		  // ·∫©n list
		  list.classList.add("hidden");
		
		  // b·∫Øn change v√†o <select>
		  select.dispatchEvent(new Event("change", { bubbles: true }));
		});

  }

  search.addEventListener("focus", () => { rebuildList();list.classList.remove("hidden");setTimeout(() => { try { search.select(); } catch(e){} }, 0);  });
  search.addEventListener("input", () => { rebuildList(); list.classList.remove("hidden"); });
	   const openList = () => { rebuildList(); list.classList.remove("hidden"); };
 search.addEventListener("focus", () => {
   openList();
   setTimeout(() => { try { search.select(); } catch(e){} }, 0);
 });
 search.addEventListener("click", openList);
 search.addEventListener("mousedown", openList
  document.addEventListener("click", (e) => {
    const wrapper = document.getElementById(`${kind}Wrapper`);
    if (!wrapper.contains(e.target)) list.classList.add("hidden");
  });

  // Sync input display from current selected
 const selOpt = select.options[select.selectedIndex];
 search.value = (selOpt && selOpt.value) ? selOpt.text : ""; // ch·ªâ hi·ªÉn th·ªã khi c√≥ value
 search.placeholder = "G√µ ƒë·ªÉ t√¨m...";
  rebuildList();

  // Expose a helper to refresh after options change
 buildSearchable[`refresh_${kind}`] = () => {
  const selOpt2 = select.options[select.selectedIndex];
  search.value = (selOpt2 && selOpt2.value) ? selOpt2.text : "";
  search.placeholder = "G√µ ƒë·ªÉ t√¨m...";
   rebuildList();
 };
}

/* ================== CASCADE DROPDOWNS ================== */
document.getElementById("province").addEventListener("change", e => {
  const province = e.target.value;

  // District options
  const districtSelect = document.getElementById("district");
  districtSelect.innerHTML = '<option value="">-- Qu·∫≠n/Huy·ªán --</option>';
  document.getElementById("ward").innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ --</option>';

  const districts = Object.keys(locationsData[province] || {});
  districts.forEach(qh => {
    districtSelect.innerHTML += `<option value="${qh}">${qh}</option>`;
  });

  // Refresh searchable UIs
  if (!buildSearchable.refresh_district) buildSearchable("district");
  else buildSearchable.refresh_district();

  if (!buildSearchable.refresh_ward) buildSearchable("ward");
  else buildSearchable.refresh_ward();

  // Reset lo·∫°i xe khi ƒë·ªïi t·ªânh
  renderCarTypeGroup([]);
  document.getElementById("carType").value = "";
});

document.getElementById("district").addEventListener("change", e => {
  const province = document.getElementById("province").value;
  const district = e.target.value;

  // Ward options
  const wardSelect = document.getElementById("ward");
  wardSelect.innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ --</option>';
  const wards = locationsData[province]?.[district] || [];
  wards.forEach(px => {
    wardSelect.innerHTML += `<option value="${px}">${px}</option>`;
  });

  // Refresh ward searchable UI
  if (!buildSearchable.refresh_ward) buildSearchable("ward");
  else buildSearchable.refresh_ward();

  // Car types as buttons
  const carTypes = (carConfigData[province]?.[district] || []).map(v => ({ value: v, label: v }));
  const savedCarType = localStorage.getItem("carType") || "";
  renderCarTypeGroup(carTypes, savedCarType);
});

/* ================== QTY ================== */
document.getElementById("increaseQty").onclick = () => {
  let val = parseInt(document.getElementById("quantity").value) || 1;
  document.getElementById("quantity").value = val + 1;
};
document.getElementById("decreaseQty").onclick = () => {
  let val = parseInt(document.getElementById("quantity").value) || 1;
  if (val > 1) document.getElementById("quantity").value = val - 1;
};

/* ================== GPS + REVERSE (NOMINATIM) ================== */
async function reverseGeocode(lat, lon) {
  // Thay email c·ªßa b·∫°n theo policy Nominatim
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&accept-language=vi&email=youremail@example.com`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Reverse geocode failed");
  return res.json();
}
document.getElementById("getLocation").onclick = () => {
  const status = document.getElementById("gpsStatus");
  if (!navigator.geolocation) {
    status.innerText = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS.";
    return;
  }
  status.innerText = "ƒêang l·∫•y v·ªã tr√≠...";
  navigator.geolocation.getCurrentPosition(async pos => {
    try {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      localStorage.setItem("gps", `${lat},${lon}`);
      const info = await reverseGeocode(lat, lon);
      const nice = info.display_name || `${lat}, ${lon}`;
      status.innerText = `üìç ${nice}`;
      const addrInput = document.getElementById("address");
      if (addrInput && !addrInput.value.trim()) {
        addrInput.value = nice;
        saveForm();
      }
    } catch (err) {
      console.error(err);
      status.innerText = "ƒê√£ l·∫•y GPS nh∆∞ng kh√¥ng ph√¢n gi·∫£i ƒë∆∞·ª£c t√™n ƒë·ªãa ƒëi·ªÉm.";
    }
  }, () => {
    status.innerText = "Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS.";
  }, { enableHighAccuracy: true, timeout: 10000 });
};

/* ================== LOCAL STORAGE (ƒë·∫ßy ƒë·ªß) ================== */
let saveTimer;
function saveForm() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    const fields = ["zaloname","phone","province","district","ward","address","quantity","carType","note","tripType","destination"];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) localStorage.setItem(id, el.value);
    });
  }, 150);
}
function cascadeLoadFromLocalStorage() {
  const get = k => localStorage.getItem(k) || "";
  ["zaloname","phone","address","quantity","note","destination"].forEach(id=>{
    if (get(id)) document.getElementById(id).value = get(id);
  });

  // Trip type buttons
   const savedTrip = get("tripType") || "Ng·∫Øn";   // m·∫∑c ƒë·ªãnh ƒëi ng·∫Øn
  renderTripTypeButtons(savedTrip);
  document.getElementById("tripType").value = savedTrip;

  // Province -> District -> Ward -> CarType (buttons)
  if (get("province")) {
    document.getElementById("province").value = get("province");
    if (buildSearchable.refresh_province) buildSearchable.refresh_province();
    document.getElementById("province").dispatchEvent(new Event("change"));
  }
  if (get("district")) {
    document.getElementById("district").value = get("district");
    if (buildSearchable.refresh_district) buildSearchable.refresh_district();
    document.getElementById("district").dispatchEvent(new Event("change"));
  }
  if (get("ward")) {
    document.getElementById("ward").value = get("ward");
    if (buildSearchable.refresh_ward) buildSearchable.refresh_ward();
  }
  const savedCar = get("carType");
  if (savedCar) {
    setTimeout(() => {
      const elHidden = document.getElementById("carType");
      elHidden.value = savedCar;
      Array.from(document.getElementById("carTypeGroup").children).forEach(btn => {
        if (btn.dataset && btn.dataset.value === savedCar) {
          btn.className = "px-3 py-2 rounded-lg border text-sm bg-indigo-600 text-white border-indigo-600";
        }
      });
    }, 0);
  }
}
document.querySelectorAll("input,select,textarea").forEach(el=>{
  el.addEventListener("change", saveForm);
  el.addEventListener("keyup", saveForm);
});

/* ================== BUTTON GROUP HELPERS ================== */
function renderButtonGroup(containerId, options, currentValue, onChange) {
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.dataset.value = opt.value;
    btn.className =
      "px-3 py-2 rounded-lg border text-sm " +
      (currentValue === opt.value
        ? "bg-lime-600 text-white border-lime-600"
        : "bg-white text-gray-700");
    btn.textContent = opt.label;

    btn.addEventListener("click", () => onChange(opt.value));
    el.appendChild(btn);
  });
}

// Trip type = 2 n√∫t c·ªë ƒë·ªãnh
function renderTripTypeButtons(currentValue="") {
  const options = [
    { value: "Ng·∫Øn", label: "ƒêi ng·∫Øn (<20km)" },
    { value: "Xa",   label: "ƒêi xa (>=20km)" }
  ];
  const onChange = (val) => {
    document.getElementById("tripType").value = val;
    localStorage.setItem("tripType", val);
    renderTripTypeButtons(val); // re-render ƒë·ªÉ c·∫≠p nh·∫≠t active
  };
  renderButtonGroup("tripTypeGroup", options, currentValue, onChange);
}

// Car type = ƒë·ªï ƒë·ªông theo t·ªânh/huy·ªán
function renderCarTypeGroup(options=[], currentValue="") {
  const onChange = (val) => {
    document.getElementById("carType").value = val;
    localStorage.setItem("carType", val);
    renderCarTypeGroup(options, val); // re-render ƒë·ªÉ c·∫≠p nh·∫≠t active
  };
  renderButtonGroup("carTypeGroup", options, currentValue, onChange);
}

/* ================== SUBMIT FLOW (CONFIRM MODAL) ================== */
function collectFormData() {
  const province = document.getElementById("province").value;
  const district = document.getElementById("district").value;
  const ward = document.getElementById("ward").value;
  const addr = document.getElementById("address").value.trim();
  const fullAddress = `${addr} - ${ward} - ${district} - ${province}`;

  return {
	zaloname: (document.getElementById("zaloname").value || "").trim(),
    phone: (document.getElementById("phone").value || "").trim(),
    province, district, ward,
    address: fullAddress,
    quantity: Number(document.getElementById("quantity").value) || 1,
    carType: document.getElementById("carType").value,
    gps: localStorage.getItem("gps") || "",
    note: (document.getElementById("note").value || "").trim(),
    tripType: document.getElementById("tripType").value,
    destination: (document.getElementById("destination").value || "").trim()
  };
}
function showModal() {
  document.getElementById("confirmModal").classList.remove("hidden");
  document.getElementById("confirmModal").classList.add("flex");
}
function hideModal() {
  document.getElementById("confirmModal").classList.add("hidden");
  document.getElementById("confirmModal").classList.remove("flex");
}
function showSuccessModal(message) {
  document.getElementById("successMsg").innerHTML = message;
  document.getElementById("successModal").classList.remove("hidden");
  document.getElementById("successModal").classList.add("flex");
}
function hideSuccessModal() {
  document.getElementById("successModal").classList.add("hidden");
  document.getElementById("successModal").classList.remove("flex");
}
function renderConfirmTable(d) {
  const rows = [
	["T√™n ng∆∞·ªùi ƒë·∫∑t", d.zaloname],
    ["SƒêT", d.phone],
    ["T·ªânh/TP", d.province],
    ["Qu·∫≠n/Huy·ªán", d.district],
    ["Ph∆∞·ªùng/X√£", d.ward],
    ["ƒê·ªãa ch·ªâ ƒë√≥n", d.address],
    ["ƒêi·ªÉm ƒë·∫øn", d.destination || "(ch∆∞a nh·∫≠p)"],
    ["Lo·∫°i cu·ªëc", d.tripType === "Xa" ? "ƒêi xa (>=20km)" : "ƒêi ng·∫Øn (<20km)"],
    ["S·ªë l∆∞·ª£ng xe", d.quantity],
    ["Lo·∫°i xe", d.carType],
    ["Ghi ch√∫", d.note || "(kh√¥ng)"]
  ];
  const tbody = document.getElementById("confirmTable");
  tbody.innerHTML = rows.map(([k,v]) =>
    `<tr><td class="py-2 pr-3 text-gray-500">${k}</td><td class="py-2 font-medium">${v}</td></tr>`
  ).join("");
}
document.getElementById("openConfirm").addEventListener("click", () => {
  const d = collectFormData();
  const status = document.getElementById("submitStatus");
  status.innerText = "";
  if (!/^0\d{9,10}$/.test(d.phone)) {
    status.innerText = "‚ö†Ô∏è SƒêT ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 0 v√† c√≥ 10‚Äì11 s·ªë.";
    return;
  }
  if (!d.province || !d.district || !d.ward || !d.address) {
    status.innerText = "‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë·ªß t·ªânh/huy·ªán/x√£ v√† nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt.";
    return;
  }
  if (!d.carType) {
    status.innerText = "‚ö†Ô∏è Vui l√≤ng ch·ªçn lo·∫°i xe.";
    return;
  }
  renderConfirmTable(d);
  showModal();
});
document.getElementById("cancelConfirm").addEventListener("click", hideModal);
document.getElementById("closeSuccess").addEventListener("click", hideSuccessModal);

/* G·ª≠i l·∫ßn cu·ªëi (sau khi x√°c nh·∫≠n) */
document.getElementById("finalSubmit").addEventListener("click", submitOrderFinal);

async function submitOrderFinal() {
  const finalSubmitBtn = document.getElementById('finalSubmit');
  finalSubmitBtn.innerHTML = '‚è≥ ƒêang g·ª≠i...';
  finalSubmitBtn.disabled = true;

  const formData = collectFormData();
  const callCenterPhone = getCallCenterPhone(formData.province);

  try {
    // L∆ØU √ù: b·ªè headers Content-Type ƒë·ªÉ tr√°nh preflight CORS
    const res = await fetch(scriptURL, {
      method: "POST",
		mode: "no-cors",
      body: JSON.stringify(formData)
    });

    let ok = false;
    try {
      const payload = await res.json();
      ok = res.ok && payload.ok !== false;
    } catch {
      // n·∫øu JSON parse kh√¥ng ƒë∆∞·ª£c (do CORS), coi l√† ok n·∫øu fetch kh√¥ng vƒÉng l·ªói
      ok = res.ok || true;
    }

    hideModal();

    if (!ok) {
      document.getElementById("submitStatus").innerText = '‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i.';
    } else {
	const successMessage =
	  `üíê ƒê√£ ghi nh·∫≠n th√¥ng tin ƒë·∫∑t xe c·ªßa Qu√Ω kh√°ch!<br><br>` +
	  `T·ªïng ƒë√†i s·∫Ω ki·ªÉm tra v√† ƒëi·ªÅu xe trong th·ªùi gian s·ªõm nh·∫•t.<br><br>` +
	  `üì≤ T·∫£i app ƒë·∫∑t xe t·∫°i: ` +
	  `<a href="https://taxinamthang.vn/taiapp" target="_blank" rel="noopener" ` +
	  `class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-lime-100 text-lime-700 font-semibold underline decoration-wavy cta-pop hover:scale-[1.03] transition">` +
	  `taxinamthang.vn/taiapp</a>` +
	  `<br><br>` +
	  `M·ªçi th·∫Øc m·∫Øc li√™n h·ªá t·ªïng ƒë√†i: ${callCenterPhone}`;

      showSuccessModal(successMessage);
      resetAllForms();
    }
  } catch (error) {
    hideModal();
    document.getElementById("submitStatus").innerText = '‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
    console.error(error);
  } finally {
    finalSubmitBtn.innerHTML = '‚úÖ X√°c nh·∫≠n ƒë·∫∑t xe';
    finalSubmitBtn.disabled = false;
  }
}

function resetAllForms() {
  const keep = ["zaloname","phone","address","province","district","ward"];
  Object.keys(localStorage).forEach(k => {
    if (!keep.includes(k)) localStorage.removeItem(k);
  });
  document.getElementById("orderForm").reset();
  // reset hidden + groups
  document.getElementById("tripType").value = "";
  document.getElementById("carType").value = "";
  renderTripTypeButtons("");
  renderCarTypeGroup([]);
  // reset searchable inputs
  ["province","district","ward"].forEach(kind=>{
    const search = document.getElementById(`${kind}Search`);
    if (search) search.value = "";
    const list = document.getElementById(`${kind}List`);
    if (list) list.classList.add("hidden");
  });
  document.getElementById("submitStatus").innerText = "";
}

/* ================== INIT BUTTON GROUPS ================== */
function renderButtonGroup(containerId, options, currentValue, onChange) {
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.dataset.value = opt.value;
    btn.className =
      "px-3 py-2 rounded-lg border text-sm " +
      (currentValue === opt.value
        ? "bg-lime-600 text-white border-lime-600"
        : "bg-white text-gray-700");
    btn.textContent = opt.label;
    btn.addEventListener("click", () => onChange(opt.value));
    el.appendChild(btn);
  });
}
function renderTripTypeButtons(currentValue="") {
  const options = [
    { value: "Ng·∫Øn", label: "ƒêi ng·∫Øn (‚â§20km)" },
    { value: "Xa",   label: "ƒêi xa (>20km)" }
  ];
  const onChange = (val) => {
    document.getElementById("tripType").value = val;
    localStorage.setItem("tripType", val);
    renderTripTypeButtons(val);
  };
  renderButtonGroup("tripTypeGroup", options, currentValue, onChange);
}
function renderCarTypeGroup(options = [], currentValue = "") {
  // ch·ªçn m·∫∑c ƒë·ªãnh 4 ch·ªó n·∫øu c√≥
  const pickDefault4 = (opts) => {
    const deaccent = s => (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    for (const o of opts) {
      const t = deaccent((o.label || o.value).toLowerCase());
      // kh·ªõp c√°c ki·ªÉu vi·∫øt: "4 ch·ªó", "4-cho", "4 cho", "4cho"
      if (/\b4\s*-?\s*cho\b/.test(t) || t.includes("4 cho") || t.includes("4-cho") || t.includes("4cho")) {
        return o.value;
      }
    }
    return null;
  };

  let value = currentValue;
  if (!value && options.length) {
    const def = pickDefault4(options) || options[0].value; // fallback: ph·∫ßn t·ª≠ ƒë·∫ßu
    document.getElementById("carType").value = def;
    localStorage.setItem("carType", def);
    value = def;
  }

  const onChange = (val) => {
    document.getElementById("carType").value = val;
    localStorage.setItem("carType", val);
    renderCarTypeGroup(options, val); // re-render ƒë·ªÉ t√¥ n√∫t active
  };

  renderButtonGroup("carTypeGroup", options, value, onChange);
}

</script>
</body>
</html>
