<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ƒê·∫∑t xe Taxi ƒëi·ªán Nam Th·∫Øng</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-md mx-auto">
    <header class="p-4 sticky top-0 bg-white/90 backdrop-blur z-10 border-b">
      <h1 class="text-xl font-bold text-center text-indigo-600">ƒê·∫∑t xe Taxi ƒëi·ªán Nam Th·∫Øng</h1>
    </header>

    <form id="orderForm" class="p-4 space-y-5">
      <!-- Li√™n h·ªá -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">Th√¥ng tin li√™n h·ªá</h2>
        <input id="phone" name="phone" type="tel" required inputmode="numeric" pattern="^0\\d{9,10}$"
               placeholder="S·ªë ƒëi·ªán tho·∫°i (VD: 0912345678)"
               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
      </section>

      <!-- ƒêi·ªÉm ƒë√≥n -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">ƒêi·ªÉm ƒë√≥n</h2>
        <div class="grid grid-cols-1 gap-2">
          <select id="province" required class="w-full p-3 border rounded-lg">
            <option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>
          </select>
          <div class="grid grid-cols-2 gap-2">
            <select id="district" required class="p-3 border rounded-lg">
              <option value="">-- Qu·∫≠n/Huy·ªán --</option>
            </select>
            <select id="ward" required class="p-3 border rounded-lg">
              <option value="">-- Ph∆∞·ªùng/X√£ --</option>
            </select>
          </div>
          <input id="address" type="text" required placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt"
                 class="w-full p-3 border rounded-lg">
          <button type="button" id="getLocation"
                  class="w-full bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg">
            üìç L·∫•y v·ªã tr√≠ GPS & ph√¢n gi·∫£i t√™n (mi·ªÖn ph√≠)
          </button>
          <p id="gpsStatus" class="text-sm text-gray-500"></p>
        </div>
      </section>

      <!-- ƒêi·ªÉm ƒë·∫øn -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">ƒêi·ªÉm ƒë·∫øn</h2>
        <input id="destination" type="text" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë·∫øn (ƒë∆∞·ªùng, s·ªë nh√†...)"
               class="w-full p-3 border rounded-lg">
      </section>

      <!-- H√†nh tr√¨nh & xe -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">H√†nh tr√¨nh & xe</h2>
        <div class="flex items-center gap-2 mb-3">
          <label class="text-gray-600">S·ªë kh√°ch:</label>
          <button type="button" id="decreaseQty" class="px-3 py-2 bg-gray-100 rounded-lg">-</button>
          <input id="quantity" type="number" min="1" value="1" required class="w-16 text-center border rounded-lg">
          <button type="button" id="increaseQty" class="px-3 py-2 bg-gray-100 rounded-lg">+</button>
        </div>

        <select id="tripType" required class="w-full p-3 border rounded-lg mb-3">
          <option value="">-- Lo·∫°i cu·ªëc --</option>
          <option value="ngan">Chuy·∫øn ƒëi ng·∫Øn (&le; 20km)</option>
          <option value="xa">Chuy·∫øn ƒëi xa (&gt; 20km)</option>
        </select>

        <select id="carType" required class="w-full p-3 border rounded-lg">
          <option value="">-- Ch·ªçn lo·∫°i xe --</option>
        </select>
      </section>

      <!-- Ghi ch√∫ -->
      <section class="bg-white rounded-xl p-4 shadow-sm">
        <h2 class="text-base font-semibold text-gray-700 mb-3">Ghi ch√∫</h2>
        <textarea id="note" rows="3" placeholder="V√≠ d·ª•: ƒê√≥n l√∫c 8h, c√≥ h√†nh l√Ω..."
                  class="w-full p-3 border rounded-lg"></textarea>
      </section>

      <!-- Submit sticky -->
      <div class="h-24"></div>
      <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-3">
        <button type="button" id="openConfirm" 
                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
          üöï ƒê·∫∑t cu·ªëc ngay
        </button>
        <p id="submitStatus" class="text-center text-sm mt-2"></p>
      </div>
    </form>
  </div>

  <!-- Modal x√°c nh·∫≠n -->
  <div id="confirmModal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center justify-center z-50">
    <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl p-4">
      <h3 class="text-lg font-semibold mb-3">X√°c nh·∫≠n ƒë·∫∑t chuy·∫øn</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <tbody id="confirmTable" class="align-top"></tbody>
        </table>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="cancelConfirm" class="flex-1 py-2 rounded-lg border">Kh√¥ng</button>
        <button id="finalSubmit" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white font-semibold">‚úÖ X√°c nh·∫≠n ƒë·∫∑t xe</button>
      </div>
    </div>
  </div>

  <!-- Modal th√†nh c√¥ng -->
  <div id="successModal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center justify-center z-50">
    <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl p-4">
      <h3 class="text-lg font-semibold mb-3">ƒê·∫∑t chuy·∫øn th√†nh c√¥ng</h3>
      <p id="successMsg" class="text-sm text-gray-700 whitespace-pre-line"></p>
      <div class="mt-4">
        <button id="closeSuccess" class="w-full py-2 rounded-lg bg-indigo-600 text-white font-semibold">ƒê√≥ng</button>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const scriptURL = "https://script.google.com/macros/s/AKfycbx8EVqG37czQ9ACGPHKDrOD6LUxmVXOLBJxdyKdwvb8YA6EIgfL-c6l0lUgEzHkJFeHLg/exec"; // WebApp URL
let locationsData = {};
let carConfigData = {};

/* T·ªïng ƒë√†i theo t·ªânh */
function getCallCenterPhone(province) {
  const phoneNumbers = {
    'An Giang': '02973 56 56 56',
    'C√† Mau': '02903 56 56 56',
    'H·∫≠u Giang': '02973 95 95 95',
    'Ki√™n Giang': '02973 69 69 69',
    'Ph√∫ Qu·ªëc': '02973 75 75 75',
    'B·∫°c Li√™u': '02913 75 75 75',
    'S√≥c TrƒÉng': '0299 123 4567', // chu·∫©n h√≥a 1 s·ªë cho S√≥c TrƒÉng
    'Vƒ©nh Long': '02913 59 59 59'
  };
  return phoneNumbers[province] || '0938 267 888';
}

/* ================== LOAD DATA ================== */
async function loadData() {
  try {
    const locRes = await fetch("locations.json");
    locationsData = await locRes.json();

    const carRes = await fetch("cau_hinh_xe.json");
    carConfigData = await carRes.json();

    const provinceSelect = document.getElementById("province");
    provinceSelect.innerHTML = '<option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>';
    Object.keys(locationsData).forEach(tinh => {
      provinceSelect.innerHTML += `<option value="${tinh}">${tinh}</option>`;
    });

    cascadeLoadFromLocalStorage();
  } catch (e) {
    document.getElementById("submitStatus").innerText = "‚ö†Ô∏è Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu c·∫•u h√¨nh.";
    console.error(e);
  }
}
loadData();

/* ================== DROPDOWNS ================== */
document.getElementById("province").addEventListener("change", e => {
  const province = e.target.value;
  const districts = Object.keys(locationsData[province] || {});
  const districtSelect = document.getElementById("district");
  districtSelect.innerHTML = '<option value="">-- Qu·∫≠n/Huy·ªán --</option>';
  document.getElementById("ward").innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ --</option>';
  districts.forEach(qh => {
    districtSelect.innerHTML += `<option value="${qh}">${qh}</option>`;
  });

  // Reset car types khi ƒë·ªïi t·ªânh
  const carSelect = document.getElementById("carType");
  carSelect.innerHTML = '<option value="">-- Ch·ªçn lo·∫°i xe --</option>';
});

document.getElementById("district").addEventListener("change", e => {
  const province = document.getElementById("province").value;
  const district = e.target.value;
  const wards = locationsData[province]?.[district] || [];
  const wardSelect = document.getElementById("ward");
  wardSelect.innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ --</option>';
  wards.forEach(px => {
    wardSelect.innerHTML += `<option value="${px}">${px}</option>`;
  });

  // lo·∫°i xe theo t·ªânh + huy·ªán
  const carTypes = carConfigData[province]?.[district] || [];
  const carSelect = document.getElementById("carType");
  carSelect.innerHTML = '<option value="">-- Ch·ªçn lo·∫°i xe --</option>';
  carTypes.forEach(car => {
    carSelect.innerHTML += `<option value="${car}">${car}</option>`;
  });
});

/* ================== QTY ================== */
document.getElementById("increaseQty").onclick = () => {
  let val = parseInt(document.getElementById("quantity").value) || 1;
  document.getElementById("quantity").value = val + 1;
};
document.getElementById("decreaseQty").onclick = () => {
  let val = parseInt(document.getElementById("quantity").value) || 1;
  if (val > 1) document.getElementById("quantity").value = val - 1;
};

/* ================== GPS + REVERSE (FREE) ================== */
async function reverseGeocode(lat, lon) {
  // Nominatim mi·ªÖn ph√≠ (t√¥n tr·ªçng rate limit). Thay email c·ªßa b·∫°n cho ƒë√∫ng policy.
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&accept-language=vi&email=youremail@example.com`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Reverse geocode failed");
  return res.json();
}

document.getElementById("getLocation").onclick = () => {
  const status = document.getElementById("gpsStatus");
  if (!navigator.geolocation) {
    status.innerText = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS.";
    return;
  }
  status.innerText = "ƒêang l·∫•y v·ªã tr√≠...";
  navigator.geolocation.getCurrentPosition(async pos => {
    try {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      localStorage.setItem("gps", `${lat},${lon}`);

      const info = await reverseGeocode(lat, lon);
      const nice = info.display_name || `${lat}, ${lon}`;
      status.innerText = `üìç ${nice}`;

      // ∆Øu ti√™n GPS: n·∫øu user ch∆∞a nh·∫≠p ƒë·ªãa ch·ªâ ƒë√≥n th√¨ g·ª£i √Ω ƒëi·ªÅn
      const addrInput = document.getElementById("address");
      if (addrInput && !addrInput.value.trim()) {
        addrInput.value = nice;
        saveForm();
      }

      // Theo y√™u c·∫ßu: v·∫´n ƒë·ªÉ user t·ª± ch·ªçn t·ªânh ‚Äî KH√îNG t·ª± ƒë·ªông set province.
      // (N·∫øu c·∫ßn auto-g·ª£i √Ω t·ªânh: c√≥ th·ªÉ show hint ·ªü status, kh√¥ng auto select)
      // V√≠ d·ª• hint:
      // const provinceHint = info.address?.state || info.address?.province || "";
      // if (!document.getElementById("province").value && provinceHint) {
      //   status.innerText
