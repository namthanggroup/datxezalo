<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒê·∫∑t Taxi ƒëi·ªán</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f7f9;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 480px;
      margin: auto;
      padding: 15px;
    }
    h2 {
      font-size: 18px;
      margin: 15px 0 8px;
      color: #333;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      font-size: 14px;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      box-sizing: border-box;
    }
    button {
      background: #28a745;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .spinner {
      display: none;
      text-align: center;
      margin: 10px 0;
    }
    .spinner div {
      width: 24px;
      height: 24px;
      border: 3px solid #28a745;
      border-top: 3px solid transparent;
      border-radius: 50%;
      margin: auto;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöñ ƒê·∫∑t Taxi ƒëi·ªán</h1>
    <form id="bookingForm">

      <!-- Th√¥ng tin li√™n h·ªá -->
      <div class="card">
        <h2>Th√¥ng tin li√™n h·ªá</h2>
        <label for="phone">S·ªë ƒëi·ªán tho·∫°i *</label>
        <input type="tel" id="phone" name="phone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
      </div>

      <!-- ƒê·ªãa ch·ªâ -->
      <div class="card">
        <h2>ƒê·ªãa ch·ªâ</h2>
        <label for="tinh">T·ªânh/Th√†nh ph·ªë *</label>
        <select id="tinh" required></select>

        <label for="huyen">Qu·∫≠n/Huy·ªán *</label>
        <select id="huyen" required></select>

        <label for="xa">Ph∆∞·ªùng/X√£ *</label>
        <select id="xa" required></select>

        <label for="diaChiChiTiet">ƒê·ªãa ch·ªâ chi ti·∫øt *</label>
        <input type="text" id="diaChiChiTiet" required placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng...">

        <button type="button" id="btnLocation">üìç L·∫•y v·ªã tr√≠ GPS</button>
        <input type="hidden" id="toaDo">
      </div>

      <!-- Ph∆∞∆°ng ti·ªán -->
      <div class="card">
        <h2>Th√¥ng tin ph∆∞∆°ng ti·ªán</h2>
        <label for="soLuongXe">S·ªë l∆∞·ª£ng xe *</label>
        <input type="number" id="soLuongXe" min="1" value="1" required>

        <label for="loaiXe">Lo·∫°i xe *</label>
        <select id="loaiXe" required></select>
      </div>

      <!-- Ghi ch√∫ -->
      <div class="card">
        <h2>Ghi ch√∫</h2>
        <textarea id="ghiChu" rows="3" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)"></textarea>
      </div>

      <!-- Submit -->
      <button type="submit">üöÄ ƒê·∫∑t xe</button>
      <div class="spinner"><div></div><p>ƒêang x·ª≠ l√Ω...</p></div>
    </form>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx8EVqG37czQ9ACGPHKDrOD6LUxmVXOLBJxdyKdwvb8YA6EIgfL-c6l0lUgEzHkJFeHLg/exec"; // URL WebApp Code.gs

    // LocalStorage helpers
    function saveFormData() {
      const data = {
        phone: document.getElementById('phone').value,
        tinh: document.getElementById('tinh').value,
        huyen: document.getElementById('huyen').value,
        xa: document.getElementById('xa').value,
        diaChiChiTiet: document.getElementById('diaChiChiTiet').value,
        soLuongXe: document.getElementById('soLuongXe').value,
        loaiXe: document.getElementById('loaiXe').value,
        ghiChu: document.getElementById('ghiChu').value
      };
      localStorage.setItem("bookingForm", JSON.stringify(data));
    }

    function loadFormData() {
      const data = JSON.parse(localStorage.getItem("bookingForm"));
      if (data) {
        document.getElementById('phone').value = data.phone || "";
        document.getElementById('diaChiChiTiet').value = data.diaChiChiTiet || "";
        document.getElementById('soLuongXe').value = data.soLuongXe || 1;
        document.getElementById('ghiChu').value = data.ghiChu || "";
      }
    }

    // Fetch d·ªØ li·ªáu dropdown
    let locationData = {};
    let vehicleData = {};

    async function loadData() {
      const resLoc = await fetch(SCRIPT_URL + "?action=getLocations");
      locationData = await resLoc.json();

      const resVeh = await fetch(SCRIPT_URL + "?action=getVehicles");
      vehicleData = await resVeh.json();

      populateTinh();
    }

    function populateTinh() {
      const tinhSelect = document.getElementById('tinh');
      tinhSelect.innerHTML = '<option value="">-- Ch·ªçn T·ªânh/TP --</option>';
      Object.keys(locationData).forEach(tinh => {
        tinhSelect.innerHTML += `<option value="${tinh}">${tinh}</option>`;
      });
    }

    function populateHuyen() {
      const huyenSelect = document.getElementById('huyen');
      const xaSelect = document.getElementById('xa');
      huyenSelect.innerHTML = '<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>';
      xaSelect.innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';
      const tinh = document.getElementById('tinh').value;
      if (tinh && locationData[tinh]) {
        Object.keys(locationData[tinh]).forEach(huyen => {
          huyenSelect.innerHTML += `<option value="${huyen}">${huyen}</option>`;
        });
      }
    }

    function populateXa() {
      const xaSelect = document.getElementById('xa');
      xaSelect.innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';
      const tinh = document.getElementById('tinh').value;
      const huyen = document.getElementById('huyen').value;
      if (tinh && huyen && locationData[tinh][huyen]) {
        locationData[tinh][huyen].forEach(xa => {
          xaSelect.innerHTML += `<option value="${xa}">${xa}</option>`;
        });
      }
      populateLoaiXe(); // load lo·∫°i xe theo huy·ªán
    }

    function populateLoaiXe() {
      const loaiXeSelect = document.getElementById('loaiXe');
      loaiXeSelect.innerHTML = '<option value="">-- Ch·ªçn lo·∫°i xe --</option>';
      const tinh = document.getElementById('tinh').value;
      const huyen = document.getElementById('huyen').value;
      if (tinh && huyen && vehicleData[tinh] && vehicleData[tinh][huyen]) {
        vehicleData[tinh][huyen].forEach(loaiXe => {
          loaiXeSelect.innerHTML += `<option value="${loaiXe}">${loaiXe}</option>`;
        });
      }
    }

    // L·∫•y v·ªã tr√≠ GPS
    document.getElementById('btnLocation').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const coords = pos.coords.latitude + "," + pos.coords.longitude;
          document.getElementById('toaDo').value = coords;
          alert("ƒê√£ l·∫•y t·ªça ƒë·ªô: " + coords);
        }, () => {
          alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠!");
        });
      } else {
        alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS");
      }
    });

    // Event listeners
    document.getElementById('tinh').addEventListener('change', populateHuyen);
    document.getElementById('huyen').addEventListener('change', populateXa);
    document.getElementById('xa').addEventListener('change', populateLoaiXe);

    // Submit form
    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      saveFormData();

      const spinner = document.querySelector('.spinner');
      spinner.style.display = "block";

      const data = {
        phone: document.getElementById('phone').value,
        tinh: document.getElementById('tinh').value,
        huyen: document.getElementById('huyen').value,
        xa: document.getElementById('xa').value,
        diaChiChiTiet: document.getElementById('diaChiChiTiet').value,
        soLuongXe: document.getElementById('soLuongXe').value,
        loaiXe: document.getElementById('loaiXe').value,
        toaDo: document.getElementById('toaDo').value,
        ghiChu: document.getElementById('ghiChu').value
      };

      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      });

      const result = await res.json();
      spinner.style.display = "none";
      alert(result.message || "ƒê·∫∑t xe xong!");
    });

    // Init
    loadData();
    loadFormData();
  </script>
</body>
</html>
