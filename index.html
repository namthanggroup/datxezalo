<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒê·∫∑t xe Taxi ƒêi·ªán</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; background: #f8f9fa; }
    .container { max-width: 480px; margin: auto; background: #fff; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 1rem; }
    label { display: block; margin-top: 0.8rem; font-weight: bold; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin-top: 0.4rem;
      border: 1px solid #ccc; border-radius: 6px; font-size: 1rem;
    }
    button { background: #28a745; color: white; font-weight: bold; cursor: pointer; }
    button:disabled { background: #aaa; }
    .spinner {
      display: none; margin: 1rem auto; border: 4px solid #f3f3f3;
      border-top: 4px solid #28a745; border-radius: 50%; width: 36px; height: 36px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .note { font-size: 0.9rem; color: #666; margin-top: 0.3rem; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üöñ ƒê·∫∑t xe Taxi ƒêi·ªán</h2>
    <form id="orderForm">
      <label>S·ªë ƒëi·ªán tho·∫°i *</label>
      <input type="tel" id="phone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">

      <label>T·ªânh/Th√†nh *</label>
      <select id="tinh" required></select>

      <label>Qu·∫≠n/Huy·ªán *</label>
      <select id="huyen" required></select>

      <label>Ph∆∞·ªùng/X√£ *</label>
      <select id="xa" required></select>

      <label>ƒê·ªãa ch·ªâ chi ti·∫øt *</label>
      <input type="text" id="diaChiChiTiet" required placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng...">

      <label>S·ªë l∆∞·ª£ng xe *</label>
      <input type="number" id="soLuongXe" value="1" min="1" required>

      <label>Lo·∫°i xe *</label>
      <select id="loaiXe" required></select>

      <label>T·ªça ƒë·ªô (t√πy ch·ªçn)</label>
      <button type="button" id="getLocation">üìç L·∫•y v·ªã tr√≠ GPS</button>
      <input type="text" id="toaDo" readonly>

      <label>Ghi ch√∫</label>
      <textarea id="ghiChu" rows="2" placeholder="Ghi ch√∫ th√™m (n·∫øu c√≥)"></textarea>

      <div class="spinner" id="spinner"></div>
      <button type="submit">G·ª≠i ƒë∆°n ƒë·∫∑t xe</button>
    </form>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx8EVqG37czQ9ACGPHKDrOD6LUxmVXOLBJxdyKdwvb8YA6EIgfL-c6l0lUgEzHkJFeHLg/exec"; // Thay b·∫±ng URL WebApp c·ªßa Code.gs
let locationsData = {};
let vehiclesData = {};

// Prefill t·ª´ localStorage
window.onload = function() {
  ["phone","tinh","huyen","xa","diaChiChiTiet","soLuongXe","loaiXe","toaDo","ghiChu"]
    .forEach(id => { if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id); });

  loadLocations();
  loadVehicles();
};

function loadLocations() {
  fetch(`${SCRIPT_URL}?action=getLocations`)
    .then(res => res.json())
    .then(data => {
      locationsData = data;
      renderTinh();
    });
}

function loadVehicles() {
  fetch(`${SCRIPT_URL}?action=getVehicles`)
    .then(res => res.json())
    .then(data => {
      vehiclesData = data;
      renderLoaiXe();
    });
}

function renderTinh() {
  const tinh = document.getElementById("tinh");
  tinh.innerHTML = `<option value="">-- Ch·ªçn T·ªânh/Th√†nh --</option>`;
  Object.keys(locationsData).forEach(t => {
    tinh.innerHTML += `<option value="${t}">${t}</option>`;
  });
  if(localStorage.getItem("tinh")) {
    tinh.value = localStorage.getItem("tinh");
    renderHuyen();
  }
}

function renderHuyen() {
  const huyen = document.getElementById("huyen");
  huyen.innerHTML = `<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>`;
  const tinhVal = document.getElementById("tinh").value;
  if (tinhVal && locationsData[tinhVal]) {
    Object.keys(locationsData[tinhVal]).forEach(h => {
      huyen.innerHTML += `<option value="${h}">${h}</option>`;
    });
  }
  if(localStorage.getItem("huyen")) {
    huyen.value = localStorage.getItem("huyen");
    renderXa();
    renderLoaiXe();
  }
}

function renderXa() {
  const xa = document.getElementById("xa");
  xa.innerHTML = `<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>`;
  const tinhVal = document.getElementById("tinh").value;
  const huyenVal = document.getElementById("huyen").value;
  if (tinhVal && huyenVal && locationsData[tinhVal][huyenVal]) {
    locationsData[tinhVal][huyenVal].forEach(x => {
      xa.innerHTML += `<option value="${x}">${x}</option>`;
    });
  }
  if(localStorage.getItem("xa")) xa.value = localStorage.getItem("xa");
}

function renderLoaiXe() {
  const loaiXe = document.getElementById("loaiXe");
  loaiXe.innerHTML = `<option value="">-- Ch·ªçn lo·∫°i xe --</option>`;
  const tinhVal = document.getElementById("tinh").value;
  const huyenVal = document.getElementById("huyen").value;
  if (tinhVal && huyenVal && vehiclesData[tinhVal] && vehiclesData[tinhVal][huyenVal]) {
    vehiclesData[tinhVal][huyenVal].forEach(lx => {
      loaiXe.innerHTML += `<option value="${lx}">${lx}</option>`;
    });
  }
  if(localStorage.getItem("loaiXe")) loaiXe.value = localStorage.getItem("loaiXe");
}

// S·ª± ki·ªán onchange
document.getElementById("tinh").onchange = () => { renderHuyen(); saveForm(); };
document.getElementById("huyen").onchange = () => { renderXa(); renderLoaiXe(); saveForm(); };
document.getElementById("xa").onchange = saveForm;
document.getElementById("loaiXe").onchange = saveForm;
document.getElementById("phone").oninput = saveForm;
document.getElementById("diaChiChiTiet").oninput = saveForm;
document.getElementById("soLuongXe").oninput = saveForm;
document.getElementById("ghiChu").oninput = saveForm;

function saveForm() {
  ["phone","tinh","huyen","xa","diaChiChiTiet","soLuongXe","loaiXe","toaDo","ghiChu"]
    .forEach(id => localStorage.setItem(id, document.getElementById(id).value));
}

// L·∫•y v·ªã tr√≠ GPS
document.getElementById("getLocation").onclick = () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const coords = pos.coords.latitude + "," + pos.coords.longitude;
      document.getElementById("toaDo").value = coords;
      localStorage.setItem("toaDo", coords);
    }, () => alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠"));
  } else {
    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS");
  }
};

// Submit form
document.getElementById("orderForm").onsubmit = e => {
  e.preventDefault();
  const spinner = document.getElementById("spinner");
  spinner.style.display = "block";

  const data = {
    phone: document.getElementById("phone").value,
    tinh: document.getElementById("tinh").value,
    huyen: document.getElementById("huyen").value,
    xa: document.getElementById("xa").value,
    diaChiChiTiet: document.getElementById("diaChiChiTiet").value,
    soLuongXe: document.getElementById("soLuongXe").value,
    loaiXe: document.getElementById("loaiXe").value,
    toaDo: document.getElementById("toaDo").value,
    ghiChu: document.getElementById("ghiChu").value
  };

  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    spinner.style.display = "none";
    alert(res.message || "G·ª≠i th√†nh c√¥ng!");
  })
  .catch(err => {
    spinner.style.display = "none";
    alert("L·ªói g·ª≠i d·ªØ li·ªáu: " + err.message);
  });
};
</script>
</body>
</html>
