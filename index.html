<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒê·∫∑t xe Taxi ƒëi·ªán Nam Th·∫Øng</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-xl rounded-2xl p-6 w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-6 text-indigo-600">ƒê·∫∑t xe Taxi ƒëi·ªán Nam Th·∫Øng</h1>

    <form id="orderForm" class="space-y-6">
      <!-- Li√™n h·ªá -->
      <div>
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Th√¥ng tin li√™n h·ªá</h2>
        <input id="phone" name="phone" type="tel" required 
               placeholder="S·ªë ƒëi·ªán tho·∫°i *"
               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- ƒê·ªãa ch·ªâ -->
      <div>
        <h2 class="text-lg font-semibold text-gray-700 mb-2">ƒê·ªãa ch·ªâ</h2>
        <select id="province" required class="w-full p-3 border rounded-lg mb-2">
          <option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>
        </select>
        <select id="district" required class="w-full p-3 border rounded-lg mb-2">
          <option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>
        </select>
        <select id="ward" required class="w-full p-3 border rounded-lg mb-2">
          <option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>
        </select>
        <input id="address" type="text" required 
               placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt *"
               class="w-full p-3 border rounded-lg mb-2">
        <button type="button" id="getLocation"
                class="w-full bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg">
          üìç L·∫•y v·ªã tr√≠ GPS hi·ªán t·∫°i
        </button>
        <p id="gpsStatus" class="text-sm text-gray-500 mt-1"></p>
      </div>

      <!-- Ph∆∞∆°ng ti·ªán -->
      <div>
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Th√¥ng tin ph∆∞∆°ng ti·ªán</h2>
        <div class="flex items-center mb-2">
          <button type="button" id="decreaseQty" class="px-3 py-1 bg-gray-200 rounded-l">-</button>
          <input id="quantity" type="number" min="1" value="1" required
                 class="w-16 text-center border-t border-b">
          <button type="button" id="increaseQty" class="px-3 py-1 bg-gray-200 rounded-r">+</button>
        </div>
        <select id="carType" required class="w-full p-3 border rounded-lg">
          <option value="">-- Ch·ªçn lo·∫°i xe --</option>
        </select>
      </div>

      <!-- Ghi ch√∫ -->
      <div>
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Ghi ch√∫</h2>
        <textarea id="note" rows="3" placeholder="Nh·∫≠p ghi ch√∫..."
                  class="w-full p-3 border rounded-lg"></textarea>
      </div>

      <!-- Submit -->
      <button type="submit" id="submitBtn"
              class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
        üöï ƒê·∫∑t xe ngay
      </button>
      <p id="submitStatus" class="text-center text-sm mt-2"></p>
    </form>
  </div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbx8EVqG37czQ9ACGPHKDrOD6LUxmVXOLBJxdyKdwvb8YA6EIgfL-c6l0lUgEzHkJFeHLg/exec"; // ƒëi·ªÅn link WebApp

let locationsData = {};
let carConfigData = {};

// Load JSON tƒ©nh
async function loadData() {
  const locRes = await fetch("locations.json");
  locationsData = await locRes.json();
  const carRes = await fetch("cau_hinh_xe.json");
  carConfigData = await carRes.json();

  // T·ªânh
  Object.keys(locationsData).forEach(tinh => {
    document.getElementById("province").innerHTML += `<option value="${tinh}">${tinh}</option>`;
  });
}
loadData();

// Dropdown ƒë·ªông
document.getElementById("province").addEventListener("change", e => {
  const province = e.target.value;
  const districts = Object.keys(locationsData[province] || {});
  const districtSelect = document.getElementById("district");
  districtSelect.innerHTML = '<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>';
  document.getElementById("ward").innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';
  districts.forEach(qh => {
    districtSelect.innerHTML += `<option value="${qh}">${qh}</option>`;
  });
});

document.getElementById("district").addEventListener("change", e => {
  const province = document.getElementById("province").value;
  const district = e.target.value;
  const wards = locationsData[province]?.[district] || [];
  const wardSelect = document.getElementById("ward");
  wardSelect.innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';
  wards.forEach(px => {
    wardSelect.innerHTML += `<option value="${px}">${px}</option>`;
  });

  // lo·∫°i xe theo t·ªânh + huy·ªán
  const carTypes = carConfigData[province]?.[district] || [];
  const carSelect = document.getElementById("carType");
  carSelect.innerHTML = '<option value="">-- Ch·ªçn lo·∫°i xe --</option>';
  carTypes.forEach(car => {
    carSelect.innerHTML += `<option value="${car}">${car}</option>`;
  });
});

// TƒÉng gi·∫£m s·ªë l∆∞·ª£ng
document.getElementById("increaseQty").onclick = () => {
  let val = parseInt(document.getElementById("quantity").value) || 1;
  document.getElementById("quantity").value = val + 1;
};
document.getElementById("decreaseQty").onclick = () => {
  let val = parseInt(document.getElementById("quantity").value) || 1;
  if(val > 1) document.getElementById("quantity").value = val - 1;
};

// GPS
document.getElementById("getLocation").onclick = () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      document.getElementById("gpsStatus").innerText = 
        `Lat: ${pos.coords.latitude}, Lng: ${pos.coords.longitude}`;
      localStorage.setItem("gps", `${pos.coords.latitude},${pos.coords.longitude}`);
    }, () => {
      document.getElementById("gpsStatus").innerText = "Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS.";
    });
  }
};

// LocalStorage Prefill
function saveForm() {
  const fields = ["phone","province","district","ward","address","quantity","carType","note"];
  fields.forEach(id => localStorage.setItem(id, document.getElementById(id).value));
}
function loadForm() {
  const fields = ["phone","province","district","ward","address","quantity","carType","note"];
  fields.forEach(id => {
    if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
  });
}
loadForm();
document.querySelectorAll("input,select,textarea").forEach(el=>{
  el.addEventListener("change", saveForm);
  el.addEventListener("keyup", saveForm);
});

// Submit
document.getElementById("orderForm").addEventListener("submit", async e => {
  e.preventDefault();
  const btn = document.getElementById("submitBtn");
  btn.disabled = true; btn.innerText = "‚è≥ ƒêang g·ª≠i...";
  const province = document.getElementById("province").value;
  const district = document.getElementById("district").value;
  const ward = document.getElementById("ward").value;
  const addr = document.getElementById("address").value;
  const fullAddress = `${addr} - ${ward} - ${district} - ${province}`;

  const data = {
    phone: document.getElementById("phone").value,
    province, district, ward,
    address: fullAddress,
    quantity: document.getElementById("quantity").value,
    carType: document.getElementById("carType").value,
    gps: localStorage.getItem("gps") || "",
    note: document.getElementById("note").value
  };

  try {
    const res = await fetch(scriptURL, { method:"POST", body: JSON.stringify(data) });
    document.getElementById("submitStatus").innerText = "‚úÖ G·ª≠i th√†nh c√¥ng!";
  } catch(err) {
    document.getElementById("submitStatus").innerText = "‚ùå L·ªói g·ª≠i d·ªØ li·ªáu!";
  }
  btn.disabled = false; btn.innerText = "üöï ƒê·∫∑t xe ngay";
});
</script>
</body>
</html>
